---
title: "Secrets Rotation"
description: "_Last updated: 2026-01-04_"
---

# Secrets Rotation Runbook

_Last updated: 2026-01-04_

This runbook documents procedures for rotating secrets across DormWay infrastructure.

## Overview

DormWay uses **Doppler** as the central secrets management platform. All secrets are stored in Doppler and injected into services at runtime.

### Secrets Inventory

| Category | Secret Type | Rotation Frequency | Auto-Rotation |
|----------|------------|-------------------|---------------|
| **Database** | Neon connection strings | Quarterly | No |
| **Authentication** | Clerk API keys | Quarterly | No |
| **Messaging** | Customer.io API key | Annually | No |
| **Messaging** | Ably API key | Annually | No |
| **AI/ML** | PortKey API key | Annually | No |
| **AI/ML** | OpenAI API key | Annually | No |
| **AI/ML** | Anthropic API key | Annually | No |
| **Storage** | AWS S3 credentials | Quarterly | IAM rotation |
| **Observability** | Sentry DSN | Never (public) | N/A |
| **Observability** | Dash0 token | Annually | No |
| **Gateway** | Zuplo API keys | Quarterly | No |
| **Dev Tokens** | Doppler service tokens | 24h (dev) | Yes |

---

## Scheduled Rotation Procedures

### Quarterly Rotations

#### 1. Database Credentials (Neon)

```bash
# 1. Generate new password in Neon Console
# Navigate to: https://console.neon.tech/app/projects/[project-id]/settings/users

# 2. Update in Doppler (all environments)
doppler secrets set DATABASE_URL="postgresql://user:NEW_PASSWORD@host/db" \
  --project dormway --config prd

doppler secrets set DATABASE_URL_ADMIN="postgresql://admin:NEW_PASSWORD@host/db" \
  --project dormway --config prd

# 3. Restart services to pick up new credentials
# Services automatically pull from Doppler on restart

# 4. Verify connectivity
curl https://api.dormway.com/health

# 5. Revoke old password in Neon Console after verification
```

#### 2. Clerk API Keys

```bash
# 1. Generate new API key in Clerk Dashboard
# Navigate to: https://dashboard.clerk.com/apps/[app-id]/instances/[instance]/api-keys

# 2. Update in Doppler
doppler secrets set CLERK_SECRET_KEY="sk_live_NEW_KEY" \
  --project dormway --config prd

doppler secrets set NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY="pk_live_NEW_KEY" \
  --project dormway --config prd

# 3. Redeploy affected services
# - api-router
# - dormway-lockedin

# 4. Verify authentication flow works
# Test login at https://app.dormway.com

# 5. Delete old key in Clerk Dashboard
```

#### 3. AWS Credentials

```bash
# For IAM users with programmatic access:

# 1. Create new access key
aws iam create-access-key --user-name service-account

# 2. Update in Doppler
doppler secrets set AWS_ACCESS_KEY_ID="AKIA_NEW_KEY" \
  --project dormway --config prd
doppler secrets set AWS_SECRET_ACCESS_KEY="new_secret" \
  --project dormway --config prd

# 3. Verify S3 access
aws s3 ls s3://dormway-syllabi-bucket

# 4. Deactivate old key
aws iam update-access-key --user-name service-account \
  --access-key-id AKIA_OLD_KEY --status Inactive

# 5. Delete old key after 24h verification period
aws iam delete-access-key --user-name service-account \
  --access-key-id AKIA_OLD_KEY
```

### Annual Rotations

#### 4. Customer.io API Key

```bash
# 1. Generate new API key in Customer.io
# Navigate to: https://fly.customer.io/settings/api_credentials

# 2. Update in Doppler
doppler secrets set CUSTOMERIO_API_KEY="new_key" \
  --project dormway --config prd

# 3. Verify push notification delivery
# Send test notification and confirm receipt

# 4. Delete old key in Customer.io
```

#### 5. Ably API Key

```bash
# 1. Generate new API key in Ably Dashboard
# Navigate to: https://ably.com/accounts/[account]/apps/[app]/api-keys

# 2. Update in Doppler
doppler secrets set ABLY_API_KEY="new_key" \
  --project dormway --config prd

# 3. Restart ably-relay service

# 4. Verify real-time messaging
# Test dashboard updates in app

# 5. Revoke old key in Ably Dashboard
```

#### 6. LLM Provider Keys (PortKey, OpenAI, Anthropic)

```bash
# PortKey
doppler secrets set PORTKEY_API_KEY="new_key" --project dormway --config prd

# OpenAI (via PortKey)
doppler secrets set OPENAI_API_KEY="sk-new_key" --project dormway --config prd

# Anthropic (via PortKey)
doppler secrets set ANTHROPIC_API_KEY="sk-ant-new_key" --project dormway --config prd

# Verify AI functionality
curl -X POST https://api.dormway.com/api/v1/ace/query -d '{"query":"test"}'
```

---

## Emergency Rotation Procedures

### Suspected Compromise

If a secret is suspected to be compromised:

```bash
# 1. IMMEDIATELY rotate the affected secret
# Follow the specific rotation procedure above

# 2. Revoke the old secret BEFORE deploying new one if possible
# This prevents use of compromised credential

# 3. Check audit logs for unauthorized access
# Doppler: https://dashboard.doppler.com/workplace/[workspace]/logs
# AWS: CloudTrail console
# Clerk: Dashboard audit logs

# 4. Notify security team
# Post in #security-incidents

# 5. Document the incident
# Create Linear ticket with timeline

# 6. Review access patterns
# Determine scope of potential breach
```

### Developer Token Compromise

If a developer's Doppler token is compromised:

```bash
# 1. Revoke all tokens for that user
doppler configs tokens revoke --all --project dormway --config dev_[username]

# 2. Generate new token
doppler configs tokens create dev-token-$(date +%s) \
  --project dormway --config dev_[username] --max-age 24h

# 3. Audit recent access
# Check Doppler audit logs for the user
```

---

## Doppler Token Management

### Development Tokens (Auto-Expiring)

Development tokens are created with 24-hour expiration:

```bash
# Create dev token (in dev-with-doppler.sh)
DOPPLER_TOKEN=$(doppler configs tokens create docker-dev-$(date +%s) \
  --plain --config dev_[username] --max-age 24h)
```

### Service Tokens (Production)

Service tokens for production are long-lived but should be rotated quarterly:

```bash
# 1. Create new service token
doppler configs tokens create prod-$(date +%Y%m) \
  --project dormway --config prd

# 2. Update in deployment configuration
# - AWS ECS task definitions
# - GitHub Actions secrets

# 3. Deploy with new token

# 4. Revoke old token after verification
doppler configs tokens revoke OLD_TOKEN_NAME \
  --project dormway --config prd
```

### Token Cleanup Script

Run periodically to remove expired tokens:

```bash
# Located at: scripts/ops/doppler-prune-tokens.sh
./scripts/ops/doppler-prune-tokens.sh
```

---

## Rotation Schedule Calendar

| Month | Secrets to Rotate |
|-------|------------------|
| January | Database, Clerk, AWS, Zuplo |
| February | - |
| March | - |
| April | Database, Clerk, AWS, Zuplo |
| May | - |
| June | - |
| July | Database, Clerk, AWS, Zuplo + Annual (Customer.io, Ably, LLM keys) |
| August | - |
| September | - |
| October | Database, Clerk, AWS, Zuplo |
| November | - |
| December | - |

---

## Verification Checklist (Post-Rotation)

After rotating any secret:

- [ ] New secret deployed to all environments
- [ ] All services restarted and healthy
- [ ] Functionality verified (auth, database, messaging, etc.)
- [ ] Old secret revoked/deleted
- [ ] Rotation documented in Linear
- [ ] Doppler audit log shows expected access pattern

---

## Rollback Procedure

If a rotation causes issues:

```bash
# 1. Identify the problematic secret
# Check service logs for connection/auth errors

# 2. If old secret still exists, revert in Doppler
doppler secrets set SECRET_NAME="old_value" --project dormway --config prd

# 3. Restart affected services

# 4. Investigate root cause before re-attempting rotation
```

---

## Audit & Compliance

### Doppler Audit Logs

Access at: https://dashboard.doppler.com/workplace/[workspace]/logs

Logs include:
- Secret access events
- Configuration changes
- Token creation/revocation
- User access changes

### SOC 2 Evidence

For SOC 2 audits, export:
1. Doppler audit logs (quarterly)
2. Rotation completion records (Linear tickets)
3. Access review documentation

---

## Related Documents

- [Access Provisioning and Offboarding](/docs/operations/runbooks/access-provisioning-and-offboarding)
- [Incident Handling](/docs/operations/runbooks/incident-handling)
- [Doppler Integration Guide](/docs/engineering/technical/infrastructure/doppler/doppler-integration-guide)
- [Third-Party Tools & Services Inventory](/docs/engineering/architecture/third-party-tools-services-inventory)
