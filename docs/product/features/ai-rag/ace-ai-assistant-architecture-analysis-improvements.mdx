---
title: "ACE AI Assistant   Architecture Analysis & Improvements"
description: "A **hybrid RAG + structured database query system** is now operational on branch `feat/ace-llm-structured-queries`. This represents the foundation of Phase 1..."
---

# ACE AI Assistant - Architecture Analysis & Improvements

**Status**: Phase 1 In Progress - Hybrid Query System Implemented âœ…
**Date**: October 14, 2025 (Updated)
**Original Analysis**: October 9, 2025
**Analyzed By**: Claude Code
**Priority**: High - Core Product Differentiator

---

## ğŸ‰ Implementation Update (October 14, 2025)

### âœ… What's Been Implemented

A **hybrid RAG + structured database query system** is now operational on branch `feat/ace-llm-structured-queries`. This represents the foundation of Phase 1 and partial completion of Phase 2.

**Key Achievements:**
- âœ… Intent detection for assignments, schedule, and task queries
- âœ… Temporal expression parsing ("this week", "next Monday", "by Friday")
- âœ… Parallel query execution (RAG + database queries run simultaneously)
- âœ… Schema-aligned database queries for assignments and schedules
- âœ… Context formatting (DB results â†’ natural language snippets)
- âœ… Citation merging (RAG documents + database sources)

**Technical Implementation:**
- `src/utils/temporal-parser.ts` - Wraps chrono-node for date parsing
- `src/services/ace-structured-queries.ts` - Database query service
- `src/services/ace-context-formatters.ts` - Formats results for LLM
- `src/routes/ace-llm-chat-routes.ts` - Integrated into chat pipeline

**Critical Discovery:**
Assignments DUE are stored in `student_time_blocks` with `type='assignment'`, NOT in `assignment_completion` (which only tracks completion status).

**Current Capabilities:**
ACE can now correctly answer:
- âœ… "What do I have due this week?" (finds assignments from student_time_blocks)
- âœ… "What's on my schedule today?" (queries time blocks)
- âœ… Queries combine RAG context with live database data

**Linear Issue**: [DORM-342](https://linear.app/dormwayllc/issue/DORM-342) - Status: In Review

**Next Steps:**
- Add clickable Canvas links to assignment responses
- Integrate completion status from assignment_completion table
- Implement smart course-specific filtering
- Performance optimizations (caching, indexes)

---

## Executive Summary

ACE (Academic Context Engine) is DormWay's AI assistant. The initial architecture had **two disconnected systems**: a generic LLM proxy and a document-only RAG system, neither of which leveraged DormWay's comprehensive student data.

**Progress Update**: We've begun implementing a unified context assembly system to combine RAG with live student data, unlocking ACE's potential as a true "Academic Context Engine."

**Recent Achievement**: Students can now ask "What do I have due this week?" and receive accurate answers combining syllabus documents (RAG) with live assignment data (database).

---

## Table of Contents

1. [Current Architecture](#current-architecture)
2. [Critical Problems](#critical-problems)
3. [What Students Need From ACE](#what-students-need-from-ace)
4. [Improvement Roadmap](#improvement-roadmap)
5. [Technical Implementation](#technical-implementation)
6. [Expected Impact](#expected-impact)

---

## Current Architecture

### System Components

#### 1. LLM Proxy Route (`/api/llm/proxy`)
**Current State**: Simple passthrough to OpenAI via PortKey

```typescript
// services/api-router/src/routes/llm-routes.ts
router.post('/proxy', limiter, async (req, res) => {
  // Just forwards to PortKey â†’ OpenAI
  // NO RAG, NO student context, NO personalization
  const response = await axios.post(portkeyConfig, enhancedBody, {...});
  res.status(response.status).json(response.data);
});
```

**Limitations**:
- âŒ No access to student's documents
- âŒ No access to student's schedule
- âŒ No access to campus data
- âŒ No conversation memory
- âŒ Generic ChatGPT responses

**Rate Limits**: 10 requests/min per user

---

#### 2. BrainGains RAG System (`/api/braingains/*`)

**Current State**: Document-only RAG with Ragie vector database

**What It Has Access To**:
- âœ… Uploaded syllabi
- âœ… Lecture notes
- âœ… Assignments (documents)
- âœ… Textbooks
- âœ… Research papers
- âœ… Document metadata (course associations, upload dates)

**Storage Structure**:
- Each user has partition: `user_{userId}`
- Documents indexed in Ragie with metadata
- Supports filtering by: `document_type`, `courseContextId`, `content_type`

**Query Flow**:
```typescript
// Current BrainGains query
GET /api/braingains/query?q=exam+schedule&documentTypes=syllabus

â†’ Ragie semantic search in user's documents
â†’ Returns document chunks + AI summary
â†’ NO live schedule data, NO real-time context
```

**Limitations**:
- âŒ Document-only (no live database queries)
- âŒ No schedule integration
- âŒ No campus events/services
- âŒ No real-time context (current class, location)
- âŒ No conversation history

---

### ACE Query Capabilities (Updated October 14, 2025)

**âœ… Now Working (Hybrid Query System)**:

**Schedule Queries**:
- âœ… "What do I have today?" - Queries student_time_blocks
- âœ… "What's on my schedule this week?" - Date range queries with temporal parsing
- âŒ "When is my next class?" - Requires real-time detection (Phase 1.2)
- âŒ "Am I free at 3pm tomorrow?" - Requires conflict detection (Phase 1.2)

**Academic State**:
- âœ… "What assignments do I have due this week?" - Queries student_time_blocks WHERE type='assignment'
- âœ… "Show me my upcoming deadlines" - Combines assignments + exam time blocks
- âŒ "Have I submitted my EECS 280 lab?" - Requires Canvas integration (Phase 2)
- âŒ "What's my attendance in CS 101?" - Requires attendance tracking (Phase 2)

**Hybrid Queries (RAG + Database)**:
- âœ… "What do I have due this week?" - Combines syllabus context with live assignments
- âœ… Date-based queries with natural language ("next Monday", "by Friday")
- âœ… Course-filtered queries ready (not yet exposed to UI)

**âŒ Still Not Working (Requires Phase 1.2-2)**:

**Planning Questions**:
- âŒ "Should I study now or go to that event?" - Requires context assembly (Phase 1.2)
- âŒ "What's my workload like next week?" - Requires workload analysis (Phase 3)
- âŒ "When's the best time to work on this assignment?" - Requires AI planning (Phase 3)

**Campus Context**:
- âŒ "What events are happening tonight?" - Requires campus data integration (Phase 2)
- âŒ "Is the dining hall open now?" - Requires dashboard service integration (Phase 2)
- âŒ "What's the weather for my walk to class?" - Requires weather integration (Phase 2)

**Proactive Intelligence**:
- âŒ Warning about deadline clusters - Requires proactive workflow (Phase 3)
- âŒ Suggesting study times based on schedule - Requires AI scheduling (Phase 3)
- âŒ Recommending relevant campus events - Requires event matching (Phase 3)

---

## Critical Problems

### Problem 1: **Disconnected Systems**

**Issue**: LLM proxy and RAG are completely separate, with no unified context assembly.

```
Current Architecture:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   LLM Proxy     â”‚         â”‚  BrainGains RAG  â”‚
â”‚   (Generic)     â”‚         â”‚  (Documents)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“                            â†“
    OpenAI                      Ragie Docs

    âš ï¸ NO COMMUNICATION BETWEEN THEM
    âš ï¸ NO ACCESS TO LIVE STUDENT DATA
```

**Impact**: Students asking "When is my final?" get generic ChatGPT responses instead of answers from their actual syllabus.

---

### Problem 2: **Missing Real-Time Context**

**Issue**: ACE has no awareness of:
- Current time/date
- Student's current location
- Current class (or free time)
- Today's schedule
- This week's workload
- Campus events happening now

**Example Failure**:
```
Student (at 2:45 PM): "Should I study now?"
ACE: "It's important to maintain a consistent study schedule..."

SHOULD BE:
ACE: "You have CS 370 in 15 minutes. After that, you're free
      until 6pm - that's a great 3-hour block for your EECS
      280 project that's due tomorrow."
```

---

### Problem 3: **No Conversation Memory**

**Issue**: Every query is isolated - ACE has no context from previous messages.

**Example Failure**:
```
Student: "When is my EECS 280 exam?"
ACE: "Your EECS 280 Exam 2 is March 15 at 7pm in CCRB."

Student: "What should I study for it?"
ACE: "To prepare for an exam, review lecture notes, practice
      problems, and..." [generic response - forgot we're
      talking about EECS 280]

SHOULD BE:
ACE: "For EECS 280 Exam 2, focus on pointers, dynamic memory,
      and linked lists based on your syllabus. I see you have
      notes from Lecture 12-18 uploaded - want me to quiz you?"
```

---

### Problem 4: **No Proactive Intelligence**

**Issue**: ACE is purely reactive. It should warn, suggest, and guide proactively.

**Missing Capabilities**:
- âš ï¸ "You have 3 assignments due Monday - consider starting this weekend"
- ğŸ“… "Your schedule is packed Tuesday - want me to find study time?"
- ğŸ“ "Professor's office hours are in 30min - you had a question about recursion"
- ğŸ‰ "Free food at Union today 5-7pm - fits in your schedule"
- ğŸ˜´ "You have 8am class tomorrow - maybe skip that late event?"

---

### Problem 5: **Limited Data Sources**

**Current**: Only searches uploaded documents
**Should**: Hybrid search across:

```typescript
Data Sources ACE Should Query:
â”œâ”€â”€ Documents (Ragie RAG)
â”‚   â”œâ”€â”€ Syllabi
â”‚   â”œâ”€â”€ Lecture notes
â”‚   â”œâ”€â”€ Assignments
â”‚   â””â”€â”€ Textbooks
â”‚
â”œâ”€â”€ Structured Data (PostgreSQL)
â”‚   â”œâ”€â”€ time_blocks (schedule)
â”‚   â”œâ”€â”€ service_data (Canvas assignments)
â”‚   â”œâ”€â”€ contexts (courses, campus)
â”‚   â””â”€â”€ braingains_documents (metadata)
â”‚
â”œâ”€â”€ Real-Time APIs
â”‚   â”œâ”€â”€ Dashboard services (weather, dining)
â”‚   â”œâ”€â”€ Campus events
â”‚   â”œâ”€â”€ Location services
â”‚   â””â”€â”€ Ably real-time updates
â”‚
â””â”€â”€ User State
    â”œâ”€â”€ Preferences
    â”œâ”€â”€ Notification history
    â””â”€â”€ Learning patterns
```

---

## What Students Need From ACE

Based on analysis of Obsidian vault documentation and student use cases:

### Use Case 1: **Daily Planning Assistant**
"Help me figure out my day"

**Expected Interaction**:
```
Student: "What should I focus on today?"

ACE: "Good morning! Here's your Wednesday:

ğŸ“… SCHEDULE:
â€¢ 10am-11:50am: EECS 280 Lecture
â€¢ 12-1pm: Lunch (South Quad is serving your favorite today!)
â€¢ 2-3:15pm: MATH 216 Discussion
â€¢ Free after 3:15pm âœ¨

âš ï¸ URGENT:
â€¢ CS 370 Project due tomorrow 11:59pm (NOT STARTED)
â€¢ EECS 280 Lab due tonight 8pm (IN PROGRESS)

ğŸ’¡ RECOMMENDATION:
Start CS 370 project at 3:30pm in Shapiro Library (quiet,
6hr blocks available, close to your 10am class tomorrow).
Finish EECS 280 lab after dinner around 6pm."
```

---

### Use Case 2: **Study Session Planning**
"When should I study for my exam?"

**Expected Interaction**:
```
Student: "I have a PSYCH 111 exam Monday - help me study"

ACE: "PSYCH 111 Exam 3 - Monday Oct 14, 2pm

ğŸ“Š STUDY PLAN:
Based on your schedule and past patterns:

THURSDAY (Today):
â€¢ 3:30-5:30pm: Review Chapters 7-9 (2hr block free)
â€¢ 7-8pm: Quizlet flashcards before bed

FRIDAY:
â€¢ 1-4pm: Practice problems from study guide (3hr block)
â€¢ Evening: Take a break - trivia night at Union!

SATURDAY:
â€¢ 10am-1pm: Deep review session at Shapiro
â€¢ 4-6pm: Group study with Sarah (you're both in PSYCH 111)

SUNDAY:
â€¢ 2-5pm: Final review + practice exam
â€¢ 7pm: Early bed for 2pm exam Monday

ğŸ“š MATERIALS:
â€¢ Syllabus shows exam covers Ch 7-11
â€¢ You have notes from all lectures
â€¢ Study guide uploaded last week
â€¢ Want me to generate practice questions?"
```

---

### Use Case 3: **Academic Q&A with Context**
"Questions about my courses"

**Expected Interaction**:
```
Student: "What's the grading breakdown for CS 370?"

ACE: "CS 370 grading (from your syllabus):
â€¢ Projects: 40% (4 projects, 10% each)
â€¢ Exams: 35% (Midterm 15%, Final 20%)
â€¢ Labs: 15% (drop lowest 2)
â€¢ Participation: 10%

ğŸ“Š YOUR PROGRESS:
â€¢ Project 1: 94% âœ…
â€¢ Project 2: Due tomorrow âš ï¸
â€¢ Labs: 8/10 completed (89% avg)
â€¢ Midterm: Next Wednesday Oct 16

You're tracking for an A- (need 87% on remaining projects)"
```

---

### Use Case 4: **Workload Management**
"Is my schedule manageable?"

**Expected Interaction**:
```
Student: "How bad is next week?"

ACE: "Next week analysis:

âš ï¸ HEAVY WEEK - Deadlines clustered:

MONDAY 10/14:
â€¢ PSYCH 111 Exam (2pm)
â€¢ ECON 101 Problem Set due (11:59pm)

WEDNESDAY 10/16:
â€¢ CS 370 Midterm (7-9pm) ğŸ˜°
â€¢ MATH 216 Quiz

FRIDAY 10/18:
â€¢ EECS 280 Project 3 due (8pm)

ğŸš¨ CONCERN:
CS 370 and PSYCH exams same week with overlapping prep.

ğŸ’¡ RECOMMENDATION:
â€¢ Start CS 370 review this weekend (exam is 40% of grade)
â€¢ PSYCH exam is Monday - prioritize Thu-Sun
â€¢ ECON problem set is straightforward - knock out Friday
â€¢ Consider starting EECS project early (due next Friday)

Want me to block out study times?"
```

---

### Use Case 5: **Campus Life Integration**
"What should I do after class?"

**Expected Interaction**:
```
Student: "I'm free tonight - any suggestions?"

ACE: "Tonight's options:

ğŸ‰ EVENTS:
â€¢ 6-8pm: Free pizza at Engineering Career Fair (North Campus)
  â†’ Good networking + you mentioned wanting internship
  â†’ Fits before 8pm bedtime goal

â€¢ 7-9pm: Trivia Night at Union (walking distance)
  â†’ Low stress, social
  â†’ But conflicts with EECS lab due at 8pm âš ï¸

ğŸ“š STUDY SPOTS:
â€¢ Shapiro Library quiet until 10pm
â€¢ Dude Cafe open until 11pm (more social)

âš ï¸ REMINDER:
EECS 280 lab due tonight 8pm - only 30min work remaining.

ğŸ’¡ RECOMMENDATION:
Finish lab at 6pm â†’ Career Fair 6:30-7:30pm â†’ Relax evening.
Tomorrow is lighter, save studying for then."
```

---

## Improvement Roadmap

### Phase 1: Context Integration (2-3 weeks) - â³ IN PROGRESS
**Goal**: Give ACE access to student's full reality

**Status**: Hybrid query foundation complete âœ…, full context assembly in progress â³

#### 1.1 Student Context Assembly Service - â³ PARTIAL
Create unified context aggregation:

**âœ… Completed (October 14, 2025)**:
- Intent detection service (detects assignment/schedule/task queries)
- Temporal expression parsing with chrono-node
- Database query methods for assignments, timeblocks, tasks
- Parallel query execution (RAG + DB with Promise.all())
- Context formatting to natural language snippets

**â³ Remaining**:

```typescript
// New: services/api-router/src/services/ace-context-builder.ts
export async function assembleStudentContext(userId: string) {
  return {
    // Schedule & Time
    schedule: await getStudentSchedule(userId),
    currentTime: new Date(),
    currentClass: await detectCurrentClass(userId),
    nextClass: await getNextClass(userId),
    todaySchedule: await getTodaySchedule(userId),
    thisWeekSummary: await getWeekSummary(userId),

    // Academic State
    courses: await getStudentCourses(userId),
    assignments: await getUpcomingAssignments(userId),
    exams: await getUpcomingExams(userId),
    grades: await getCurrentGrades(userId),

    // Documents (RAG)
    documents: await ragieService.listDocuments(partition),
    recentQueries: await getRecentQueryTopics(userId),

    // Campus Context
    campusId: await getUserCampusId(userId),
    campusEvents: await getCampusEvents(campusId, 'today'),
    dining: await getDiningHours(campusId),
    weather: await getWeatherContext(campusId),

    // Location & Environment
    currentLocation: await getCurrentLocation(userId),
    nearbyServices: await getNearbyServices(userId),

    // User Preferences & Patterns
    preferences: await getStudentPreferences(userId),
    studyPatterns: await getStudyPatterns(userId),
    notificationHistory: await getNotificationHistory(userId),
  };
}
```

#### 1.2 Enhanced LLM Query with Context
Inject context into every query:

```typescript
// Enhanced: services/api-router/src/routes/llm-routes.ts
router.post('/query', requireUser, async (req, res) => {
  const userId = req.user.id;
  const userQuery = req.body.message;

  // Assemble full student context
  const context = await assembleStudentContext(userId);

  // Build context-aware prompt
  const systemPrompt = `You are ACE, ${context.student.firstName}'s
    academic assistant at ${context.campus.name}.

    CURRENT CONTEXT:
    - Time: ${context.currentTime}
    - Current: ${context.currentClass?.name || 'Free time'}
    - Next class: ${context.nextClass?.name} at ${context.nextClass?.time}
    - Location: ${context.currentLocation}

    TODAY'S SCHEDULE:
    ${formatSchedule(context.todaySchedule)}

    UPCOMING DEADLINES (Next 7 days):
    ${formatDeadlines(context.upcomingDeadlines)}

    THIS WEEK WORKLOAD:
    ${context.weekSummary}

    Use this context to give personalized, actionable advice.`;

  // Query with enhanced context
  const response = await llm.chat({
    system: systemPrompt,
    messages: [...conversationHistory, { role: 'user', content: userQuery }],
  });

  res.json({ answer: response, context });
});
```

#### 1.3 Conversation Memory
Add persistent chat history:

```sql
-- New table: ace_conversations
CREATE TABLE ace_conversations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES accounts(id) NOT NULL,
  session_id TEXT NOT NULL,
  messages JSONB[] DEFAULT '{}',
  context_snapshot JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  INDEX idx_ace_conversations_user_session (user_id, session_id),
  INDEX idx_ace_conversations_updated (updated_at)
);
```

**Enables follow-up questions**:
```
Student: "When is my EECS 280 exam?"
ACE: "Your EECS 280 Exam 2 is March 15 at 7pm in CCRB."

Student: "What should I study for it?"
[ACE knows context: we're discussing EECS 280 Exam 2]
ACE: "Focus on pointers and dynamic memory (Chapters 5-7).
      I see you have notes from Lecture 12-18 uploaded."
```

#### 1.4 Query Classification & Routing - âœ… COMPLETED
Smart routing to appropriate data sources:

**âœ… Implemented (October 14, 2025)**:
- Keyword-based intent detection in `aceStructuredQueryService.detectQueryIntent()`
- Detects: assignments, schedule, tasks, temporal keywords
- Parallel query execution: Ragie RAG + structured DB queries
- Temporal filter extraction (startDate, endDate, timeframe)

**Current Implementation**:
```typescript
// services/api-router/src/services/ace-structured-queries.ts
detectQueryIntent(query: string): {
  needsAssignments: boolean;
  needsSchedule: boolean;
  needsTasks: boolean;
  temporalFilters?: { startDate, endDate, dueDate, timeframe };
}

// Routes implemented:
// - Assignment keywords â†’ queryAssignments(userId, filters)
// - Schedule keywords â†’ queryTimeBlocks(userId, filters)
// - Task keywords â†’ queryTasks(userId, filters)
// - Temporal expressions â†’ parseTemporalExpression(query)
```

**Integrated into**: `src/routes/ace-llm-chat-routes.ts` - `runChatPipeline()`

**Future Enhancement**: Replace keyword matching with LLM-based classification for better accuracy

---

### Phase 2: Hybrid Intelligence (2-3 weeks) - â³ IN PROGRESS
**Goal**: Combine RAG + structured data for comprehensive answers

**Status**: Core hybrid query engine complete âœ…, campus integration pending â³

#### 2.1 Unified Query Engine - âœ… FOUNDATION COMPLETE
Merge document search with database queries:

**âœ… Implemented (October 14, 2025)**:
- Parallel execution of RAG + database queries via `Promise.all()`
- Combines Ragie document search with PostgreSQL structured queries
- Merges context snippets (structured data prepended for priority)
- Merges citations from both sources (database + documents)

**Current Implementation**:
```typescript
// services/api-router/src/routes/ace-llm-chat-routes.ts
async function runChatPipeline(opts, callbacks) {
  // 1. Detect intent
  const intent = aceStructuredQueryService.detectQueryIntent(message);

  // 2. Execute in parallel
  const queryPromises = [
    ragieService.query(...),  // Semantic search
    queryAssignments(...),    // SQL: student_time_blocks
    queryTimeBlocks(...),     // SQL: schedule events
    queryTasks(...)           // SQL: task bank
  ];
  const results = await Promise.all(queryPromises);

  // 3. Merge contexts
  const structuredSnippets = formatStructuredDataAsContext(dbResults);
  const snippets = [...structuredSnippets, ...ragResults.contextSnippets];

  // 4. Merge citations
  const citations = [...dbCitations, ...ragCitations];

  // 5. Send combined context to LLM
  return await llm.generate({ snippets, citations });
}
```

**â³ Remaining**:
- Campus context integration (events, dining, weather)
- Real-time location-based context
- Enhanced metadata extraction from documents

#### 2.2 Enhanced Document Metadata
Enrich RAG indexing with structured extraction:

```typescript
// When indexing documents, extract:
const enrichedMetadata = {
  // Basic
  userId,
  courseContextId,
  courseName,
  documentType,
  uploadDate,

  // NEW: Extracted structure
  topics: extractedTopics,              // ["recursion", "pointers", "trees"]
  assignments: extractedAssignments,    // [{name, dueDate, points, description}]
  exams: extractedExams,                // [{name, date, location, coverage}]
  gradingBreakdown: extractedGrading,   // {projects: 40%, exams: 35%, ...}
  officeHours: extractedOfficeHours,    // [{day, time, location, professor}]

  // NEW: Temporal relevance
  relevantWeeks: [1,2,3,4],             // Syllabus weeks this applies to
  semesterPhase: 'midterm',             // early/midterm/finals
  prerequisiteFor: ['later_topic'],

  // NEW: Usage tracking
  queryFrequency: 0,
  lastAccessed: null,
  studentAnnotations: [],
  relatedDocuments: [],
};
```

#### 2.3 Source Attribution
Always cite sources in responses:

```typescript
ACE Response Format:
{
  answer: "Your EECS 280 Exam 2 is March 15 at 7pm in CCRB.",
  sources: [
    {
      type: 'document',
      title: 'EECS 280 Syllabus',
      excerpt: 'Exam 2: March 15, 7:00-9:00 PM, CCRB',
      confidence: 0.95,
    },
    {
      type: 'schedule',
      title: 'Your Calendar',
      excerpt: 'EECS 280 Exam 2 blocked 6:45-9:15pm',
      confidence: 1.0,
    }
  ],
  nextActions: [
    'Review Chapters 5-7 (Pointers & Dynamic Memory)',
    'Attend review session March 13, 6pm',
    'Block study time this weekend'
  ]
}
```

---

### Phase 3: Proactive Intelligence (3-4 weeks)
**Goal**: ACE warns, suggests, and guides proactively

#### 3.1 Daily Analysis Workflow
Temporal workflow runs every morning:

```typescript
// New: services/engine/src/workflows/aceProactiveAnalysis.workflow.ts
export async function aceProactiveAnalysis(userId: string) {
  const context = await assembleStudentContext(userId);

  // AI analyzes upcoming week
  const insights = await llm.analyze({
    prompt: `Analyze this student's upcoming week and provide insights.

    SCHEDULE:
    ${JSON.stringify(context.thisWeekSchedule)}

    DEADLINES:
    ${JSON.stringify(context.upcomingDeadlines)}

    PATTERNS:
    ${JSON.stringify(context.studyPatterns)}

    Provide:
    1. Workload assessment (light/moderate/heavy/overwhelming)
    2. Deadline clusters (multiple things due same day)
    3. Schedule conflicts or gaps
    4. Recommended study blocks
    5. Wellness concerns (too much back-to-back, no breaks)
    6. Opportunities (events matching interests, office hours)
    7. Resource suggestions (study groups, tutoring)

    Output format: Actionable JSON with priority levels`,
  });

  // Store insights for later queries
  await storeAceInsights(userId, insights);

  // Send SELECTIVE notifications (only critical)
  if (insights.criticalDeadlines.length > 0) {
    await sendNotification(userId, {
      title: "âš ï¸ Heavy week ahead",
      body: `${insights.criticalDeadlines.length} deadlines + ${insights.exams.length} exams`,
      action: 'VIEW_PLAN',
      priority: 'high',
    });
  }

  // Suggest study blocks
  if (insights.studyBlockSuggestions.length > 0) {
    await createSuggestedTimeBlocks(userId, insights.studyBlockSuggestions);
  }

  return insights;
}
```

#### 3.2 Real-Time Nudges
Context-aware suggestions at the right moment:

```typescript
// Trigger points:
- Student opens app â†’ Show relevant insight
- Class ends â†’ Suggest next action
- Evening â†’ Remind about tomorrow prep
- Free block detected â†’ Study session suggestion
- Event nearby â†’ Recommend if matches interests

Example nudge:
{
  trigger: 'class_ended',
  context: {
    classJustEnded: 'EECS 280',
    timeUntilNext: '3 hours',
    upcomingDeadlines: ['CS 370 project due tomorrow'],
  },
  suggestion: {
    type: 'study_session',
    title: 'Perfect time for CS 370 project',
    description: 'You have 3 hours free. Shapiro Library is quiet right now.',
    action: 'START_TIMER',
    priority: 'high',
  }
}
```

#### 3.3 Workload Prediction
Predict heavy weeks in advance:

```typescript
export async function predictWorkload(userId: string, weekStart: Date) {
  const weekData = await getWeekData(userId, weekStart);

  const prediction = await llm.predict({
    input: {
      classes: weekData.classes,
      assignments: weekData.assignments,
      exams: weekData.exams,
      previousWeeks: weekData.previousWeeks,
      studentCapacity: await getStudentCapacity(userId),
    },
    predict: [
      'totalHoursNeeded',
      'stressLevel',
      'riskOfMissedDeadlines',
      'recommendedActions',
    ]
  });

  if (prediction.stressLevel > 7 || prediction.riskOfMissedDeadlines > 0.3) {
    // Proactive intervention
    await sendEarlyWarning(userId, prediction);
  }

  return prediction;
}
```

---

### Phase 4: Advanced Capabilities (4-6 weeks)
**Goal**: Platform differentiators vs competitors

#### 4.1 Multi-Modal Support
Handle images, diagrams, handwriting:

```typescript
// Upload photo of whiteboard notes
POST /api/ace/analyze-image
{
  image: <base64>,
  context: "Professor drew this recursion diagram in class",
  courseId: "course_eecs280"
}

Response:
{
  extracted: {
    type: 'diagram',
    content: 'Binary tree recursion example',
    concepts: ['recursion', 'binary trees', 'base case'],
  },
  stored: true,
  searchable: true,
  relatedMaterials: [
    'EECS 280 Lecture 15 notes',
    'Recursion chapter in textbook',
  ],
  suggestion: "Want me to generate practice problems on this?"
}
```

#### 4.2 Voice Interface
Hands-free ACE for walking/driving:

```typescript
// "Hey ACE, what's my afternoon look like?"

Voice Response:
"You have CS 370 lecture at 2pm in Beyster. After that,
 you're free until 6. That's a good 4-hour block for your
 EECS 280 project that's due tomorrow. Want me to set a
 reminder to start at 3:30?"
```

#### 4.3 Collaborative Features
Study group coordination:

```typescript
// Find study buddies for EECS 280
GET /api/ace/study-groups?courseId=course_eecs280

Response:
{
  suggestions: [
    {
      students: ['You', 'Sarah', 'Mike'],
      commonFreeTime: ['Saturday 10am-2pm', 'Sunday 1-4pm'],
      location: 'Shapiro Library (all nearby)',
      examDate: 'March 15',
      sharedStrengths: {
        you: 'pointers',
        sarah: 'recursion',
        mike: 'linked lists',
      },
      recommendation: 'Saturday 10am - each teach your strength'
    }
  ]
}
```

#### 4.4 Canvas Real-Time Integration
Live assignment tracking:

```typescript
// Auto-sync Canvas assignments every hour
Temporal Workflow: canvasAssignmentSync

On new assignment posted:
1. Detect assignment in Canvas
2. Extract details (due date, points, requirements)
3. Analyze against student's schedule
4. Find optimal time blocks
5. Notify student: "New CS 370 assignment posted. Due Friday.
   I found 3 good time slots this week - want to schedule?"
```

---

## Technical Implementation Details

### Data Flow Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ACE Query Request                     â”‚
â”‚              "What do I have today?"                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Query Classification                        â”‚
â”‚         (LLM determines intent & routing)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                 â”‚
          â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   RAG Search     â”‚  â”‚  Database Query  â”‚
â”‚   (Ragie)        â”‚  â”‚  (PostgreSQL)    â”‚
â”‚                  â”‚  â”‚                  â”‚
â”‚ â€¢ Documents      â”‚  â”‚ â€¢ time_blocks    â”‚
â”‚ â€¢ Syllabi        â”‚  â”‚ â€¢ service_data   â”‚
â”‚ â€¢ Notes          â”‚  â”‚ â€¢ contexts       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                       â”‚
       â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚    â”‚                  â”‚                 â”‚
       â–¼    â–¼                  â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Campus APIs  â”‚  â”‚  Location Data   â”‚  â”‚  User Prefs    â”‚
â”‚ â€¢ Events     â”‚  â”‚  â€¢ Current loc   â”‚  â”‚  â€¢ Settings    â”‚
â”‚ â€¢ Dining     â”‚  â”‚  â€¢ Nearby        â”‚  â”‚  â€¢ Patterns    â”‚
â”‚ â€¢ Weather    â”‚  â”‚  â€¢ Campus        â”‚  â”‚  â€¢ History     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                   â”‚                    â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚  Context Assembly     â”‚
               â”‚  (Unified student     â”‚
               â”‚   reality snapshot)   â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚   LLM Generation      â”‚
               â”‚   (GPT-4 with full    â”‚
               â”‚    context)           â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚   Response Assembly   â”‚
               â”‚   â€¢ Answer            â”‚
               â”‚   â€¢ Sources           â”‚
               â”‚   â€¢ Next actions      â”‚
               â”‚   â€¢ Related queries   â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚  Conversation Memory  â”‚
               â”‚  (Save to DB for      â”‚
               â”‚   follow-ups)         â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Database Schema Updates

```sql
-- Conversation history
CREATE TABLE ace_conversations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES accounts(id) NOT NULL,
  session_id TEXT NOT NULL,
  messages JSONB[] DEFAULT '{}',
  context_snapshot JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),

  INDEX idx_ace_conversations_user (user_id),
  INDEX idx_ace_conversations_session (session_id),
  INDEX idx_ace_conversations_updated (updated_at DESC)
);

-- Proactive insights
CREATE TABLE ace_insights (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES accounts(id) NOT NULL,
  insight_type TEXT NOT NULL, -- 'workload', 'deadline_cluster', 'study_suggestion'
  priority TEXT NOT NULL,     -- 'low', 'medium', 'high', 'critical'
  content JSONB NOT NULL,
  relevant_dates DATERANGE,
  dismissed BOOLEAN DEFAULT FALSE,
  acted_upon BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  expires_at TIMESTAMPTZ,

  INDEX idx_ace_insights_user_active (user_id, dismissed) WHERE NOT dismissed,
  INDEX idx_ace_insights_priority (priority, created_at DESC)
);

-- Query analytics
CREATE TABLE ace_query_analytics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES accounts(id) NOT NULL,
  query TEXT NOT NULL,
  classification TEXT,        -- 'schedule', 'document', 'planning', etc.
  sources_used JSONB,         -- Which data sources were queried
  response_time_ms INTEGER,
  satisfaction_score INTEGER, -- Optional user feedback
  created_at TIMESTAMPTZ DEFAULT NOW(),

  INDEX idx_ace_analytics_user (user_id, created_at DESC),
  INDEX idx_ace_analytics_classification (classification, created_at DESC)
);
```

---

### API Endpoint Changes

```typescript
// New unified ACE endpoint
POST /api/ace/query
{
  message: "What should I focus on today?",
  sessionId: "session_abc123",
  includeContext: true,
  responseFormat: "detailed" | "brief"
}

Response:
{
  answer: "...",
  sources: [...],
  nextActions: [...],
  relatedQueries: [...],
  context: {
    currentClass: {...},
    upcomingDeadlines: [...],
    todaySchedule: [...],
  }
}

// Proactive insights endpoint
GET /api/ace/insights?dismissed=false

Response:
{
  insights: [
    {
      type: 'deadline_cluster',
      priority: 'high',
      title: 'Heavy week ahead',
      description: '3 exams + 2 projects next week',
      actionable: true,
      suggestedActions: [...]
    }
  ]
}

// Study plan generation
POST /api/ace/generate-study-plan
{
  examId: "exam_eecs280_midterm2",
  daysUntilExam: 7,
  studyStyle: "distributed" | "intensive"
}

Response:
{
  plan: {
    dailySessions: [...],
    topics: [...],
    timeBlocks: [...],
  },
  addToCalendar: true
}
```

---

## Expected Impact

### Success Metrics

#### Phase 1 Impact (Context Integration)
**Current State**: ~40% query accuracy (generic responses)
**After Phase 1**: ~75% query accuracy

**Measurable Improvements**:
- âœ… Answers schedule questions correctly
- âœ… Provides course-specific context
- âœ… Remembers conversation history
- âœ… Routes queries to correct data sources

**User Impact**:
- Students ask ACE 3x more questions
- Average session length: 1.2 â†’ 4.5 messages (multi-turn conversations)
- 60% reduction in "I don't know" responses

---

#### Phase 2 Impact (Hybrid Intelligence)
**After Phase 2**: ~90% query accuracy

**Measurable Improvements**:
- âœ… Combines document + database knowledge
- âœ… Cites sources accurately
- âœ… Provides actionable next steps
- âœ… Understands complex queries

**User Impact**:
- 80% of queries resolved without follow-up
- Students rate answers 4.5/5 (vs 2.8/5 currently)
- 50% of students use ACE daily (vs 15% currently)

---

#### Phase 3 Impact (Proactive Intelligence)
**After Phase 3**: 3x engagement, proactive value delivery

**Measurable Improvements**:
- âœ… Warns about deadline clusters 3+ days ahead
- âœ… Suggests study times with 85% acceptance rate
- âœ… Reduces missed deadlines by 40%
- âœ… Students feel "supported" vs "overwhelmed"

**User Impact**:
- Students open app 5.2x/day (vs 1.8x currently)
- 70% report "ACE helps me stay organized"
- 25% fewer last-minute all-nighters
- Net Promoter Score: +45 â†’ +72

---

#### Phase 4 Impact (Advanced Features)
**After Phase 4**: Platform differentiation from competitors

**Competitive Advantages**:
- âœ… Only AI that knows student's schedule + documents + campus
- âœ… Voice interface for hands-free planning
- âœ… Study group coordination (network effects)
- âœ… Real-time Canvas integration

**Market Position**:
- Unique value prop vs ChatGPT (no student context)
- Unique value prop vs Notion AI (no proactive intelligence)
- Unique value prop vs Quizlet (no schedule integration)
- **Moat**: The more students use it, the better it gets (learning from patterns)

---

## Implementation Timeline

### âœ… Sprint 1-2 (Weeks 1-2): Foundation - COMPLETED (Oct 14, 2025)
- [x] Build query classification engine (keyword-based intent detection)
- [x] Create temporal parser (chrono-node integration)
- [x] Implement structured query service (assignments, schedules, tasks)
- [x] Test with example queries ("What do I have due this week?")
- [ ] Create full `assembleStudentContext()` service (partial - queries working)
- [ ] Add `ace_conversations` table (deferred - using Redis history)

**Branch**: `feat/ace-llm-structured-queries` (ready for merge)
**Linear**: [DORM-342](https://linear.app/dormwayllc/issue/DORM-342) (In Review)

---

### â³ Sprint 3-4 (Weeks 3-4): Enhanced LLM & Integration - IN PROGRESS
- [x] Build unified query engine (RAG + SQL parallel execution)
- [x] Add source attribution (citations from DB + documents)
- [x] Integrate into chat pipeline (`runChatPipeline()`)
- [ ] Complete `assembleStudentContext()` with full student reality
- [ ] Implement conversation memory (persistent chat history)
- [ ] A/B test: generic vs context-aware responses
- [ ] Add clickable Canvas links to assignment responses

**Next Priority Items**:
1. Add assignment detail linking (Canvas URLs from metadata)
2. Integrate completion status (cross-reference assignment_completion)
3. Implement smart course filtering ("What's due for CS101?")
4. Performance optimizations (caching, indexes)

---

### Sprint 5-6 (Weeks 5-6): Full Hybrid Intelligence - PLANNED
- [ ] Campus context integration (events, dining, weather from dashboard)
- [ ] Enhanced document metadata extraction
- [ ] Implement semantic caching
- [ ] Real-time location-based context
- [ ] Performance optimization (database indexes, query batching)

---

### Sprint 7-8 (Weeks 7-8): Proactive Features - PLANNED
- [ ] Create `aceProactiveAnalysis` Temporal workflow
- [ ] Build insights table + endpoints
- [ ] Implement real-time nudge system
- [ ] Workload prediction model

---

### Sprint 9-10 (Weeks 9-10): Polish & Scale - PLANNED
- [ ] Multi-modal image support
- [ ] Voice interface prototype
- [ ] Study group matching
- [ ] Canvas real-time sync

---

## Risk Mitigation

### Risk 1: Context Assembly Latency
**Concern**: Assembling full student context could be slow (multiple DB queries)

**Mitigation**:
- Cache frequently accessed context (schedule, courses)
- Use Redis for hot data (current class, today's schedule)
- Parallel async queries where possible
- Implement timeout fallbacks (return partial context if slow)

**Target**: `<500ms` context assembly, `<2s` total response time

---

### Risk 2: LLM Cost Explosion
**Concern**: Full context in every query = high token costs

**Mitigation**:
- Implement semantic caching (similar queries reuse responses)
- Use smaller models for simple queries (classification, routing)
- Only include relevant context (not full dump)
- Rate limiting per user (10 queries/min already in place)

**Budget**: $0.03/query average (GPT-4o) = $450/month for 500 DAU

---

### Risk 3: Privacy & Data Exposure
**Concern**: Showing too much data in responses could reveal sensitive info

**Mitigation**:
- User controls what data ACE can access
- Never expose other students' data
- Audit logs for all queries
- Clear data retention policies
- FERPA compliance checks

---

### Risk 4: Accuracy & Hallucinations
**Concern**: LLM might generate incorrect info (wrong exam dates, etc.)

**Mitigation**:
- Always ground answers in retrieved data (RAG + DB)
- Show sources for verification
- Confidence scores on uncertain info
- User feedback loop ("Was this helpful?")
- Human-in-loop for critical decisions (dropping courses, etc.)

---

## Success Criteria

### Phase 1 Success:
- âœ… ACE correctly answers "What do I have today?" 95%+ of the time
- âœ… 75%+ query accuracy (manual eval of 100 queries)
- âœ… Conversation history working (follow-up questions work)

### Phase 2 Success:
- âœ… 90%+ query accuracy
- âœ… Average response includes 2+ sources
- âœ… 80%+ of users rate responses 4+/5

### Phase 3 Success:
- âœ… 50%+ of users receive proactive insights weekly
- âœ… 40% reduction in missed deadlines
- âœ… 3x increase in daily active usage

### Phase 4 Success:
- âœ… Voice interface used by 30%+ of users
- âœ… Study groups feature drives 20%+ retention increase
- âœ… NPS score >70

---

## Appendix: Code Examples

### Example 1: Current Class Detection

```typescript
// services/api-router/src/services/class-detection.ts
export async function detectCurrentClass(userId: string): Promise<CurrentClass | null> {
  const now = new Date();

  // Query time_blocks for current class
  const { data: currentBlock } = await auroraClient.querySingle(`
    SELECT
      tb.id as time_block_id,
      tb.title,
      tb.start_time,
      tb.end_time,
      c.id as context_id,
      c.name as class_name,
      c.metadata->>'courseCode' as course_code,
      c.metadata->>'location' as location
    FROM time_blocks tb
    JOIN contexts c ON c.id = tb.context_id
    WHERE tb.user_id = $1
      AND tb.start_time <= $2
      AND tb.end_time >= $2
      AND tb.block_type = 'class'
    LIMIT 1
  `, [userId, now]);

  if (!currentBlock) return null;

  return {
    classId: currentBlock.context_id,
    className: currentBlock.class_name,
    courseCode: currentBlock.course_code,
    location: currentBlock.location,
    startTime: currentBlock.start_time,
    endTime: currentBlock.end_time,
    timeBlockId: currentBlock.time_block_id,
  };
}
```

---

### Example 2: Workload Analysis Prompt

```typescript
const WORKLOAD_ANALYSIS_PROMPT = `Analyze this student's upcoming week.

CURRENT DATE: ${currentDate}

THIS WEEK'S SCHEDULE:
${formatSchedule(weekSchedule)}

UPCOMING DEADLINES:
${formatDeadlines(deadlines)}

EXAMS:
${formatExams(exams)}

STUDENT'S PAST PATTERNS:
- Average study time: ${avgStudyHours}hrs/day
- Preferred study times: ${preferredTimes}
- Study session length: ${avgSessionLength}min
- Procrastination score: ${procrastinationScore}/10

PROVIDE:
1. Workload assessment (0-10 scale)
   - 0-3: Light week, time for extracurriculars
   - 4-6: Moderate, manageable with planning
   - 7-8: Heavy, need to prioritize
   - 9-10: Overwhelming, consider dropping commitments

2. Specific concerns (if any):
   - Deadline clusters (2+ things due same day)
   - Exam conflicts (overlapping study needs)
   - Schedule gaps (inefficient travel/waiting)
   - Overcommitment (no downtime)

3. Actionable recommendations:
   - When to start each assignment
   - Suggested study blocks
   - What to deprioritize
   - When to ask for help/extensions

Output as JSON following this schema:
{
  "workloadScore": 0-10,
  "assessment": "light|moderate|heavy|overwhelming",
  "concerns": [{type, description, severity}],
  "recommendations": [{action, timing, priority, reasoning}],
  "studyPlan": [{task, suggestedTime, duration, location}]
}`;
```

---

### Example 3: Hybrid Query Example

```typescript
// Query: "When is my CS 370 final exam?"

async function handleExamQuery(userId: string, query: string) {
  // 1. Extract course from query
  const course = await extractCourseFromQuery(query); // "CS 370"

  // 2. Find course context
  const { data: courseCtx } = await auroraClient.querySingle(`
    SELECT id, name, metadata
    FROM contexts
    WHERE user_id = $1
      AND type = 'course'
      AND (name ILIKE $2 OR metadata->>'courseCode' ILIKE $2)
  `, [userId, `%${course}%`]);

  if (!courseCtx) {
    return { answer: `I couldn't find a course matching "${course}" in your schedule.` };
  }

  // 3. Check time_blocks for exam
  const { data: examBlock } = await auroraClient.querySingle(`
    SELECT * FROM time_blocks
    WHERE user_id = $1
      AND context_id = $2
      AND block_type = 'exam'
      AND start_time > NOW()
    ORDER BY start_time ASC
    LIMIT 1
  `, [userId, courseCtx.id]);

  // 4. ALSO query RAG for syllabus confirmation
  const ragResult = await ragieService.query(
    [`user_${userId}`],
    `${course} final exam date time location`,
    { courseContextId: courseCtx.id, documentType: 'syllabus' },
    3
  );

  // 5. Combine sources
  const answer = {
    fromSchedule: examBlock ? {
      date: examBlock.start_time,
      location: examBlock.metadata?.location,
      duration: calculateDuration(examBlock.start_time, examBlock.end_time),
    } : null,

    fromSyllabus: ragResult.sources.length > 0 ? {
      excerpt: ragResult.sources[0].snippet,
      confidence: ragResult.sources[0].score,
    } : null,

    // Synthesize answer
    answer: generateExamAnswer(examBlock, ragResult),
    sources: [
      { type: 'schedule', data: examBlock },
      { type: 'document', data: ragResult.sources[0] }
    ],
    nextActions: [
      `Review ${course} exam coverage (Chapters X-Y)`,
      `Attend review session (if offered)`,
      `Block study time this week`,
    ]
  };

  return answer;
}
```

---

## Related Documents

- BrainGains - Document RAG system architecture
- [Student Context System](/docs/product/features/context-system/readme) - Context hierarchy and relationships
- [Dashboard BFF v1](/docs/engineering/architecture/bff-dashboard-v1) - Real-time data aggregation patterns
- [Ragie Integration](/docs/engineering/technical/ai/rag/ragie-ingestion-webhooks-and-ace-query-pipeline-deep-dive-current) - Vector database implementation
- [Student Reality Filter](/docs/product/features/student-experience/student-reality-filter) - Context-aware data filtering

---

## Tags

#ai #rag #ace #llm #architecture #roadmap #student-experience #context-engine

---

**Next Steps**:
1. Review with team
2. Prioritize Phase 1 tasks
3. Create JIRA tickets for Sprint 1-2
4. Begin `assembleStudentContext()` implementation
5. Set up A/B testing framework for measuring impact
