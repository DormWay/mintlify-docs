---
title: "Auth0 Integration Guide"
description: "This guide details the technical implementation for integrating Auth0 into the DormWay platform, replacing Supabase Auth."
---

# Auth0 Integration Guide

## Overview
This guide details the technical implementation for integrating Auth0 into the DormWay platform, replacing Supabase Auth.

## Auth0 Configuration

### 1. Tenant Setup
```
Domain: dormway.auth0.com (or custom domain)
Region: US (US-1)
Environment: Production
```

### 2. Applications Configuration

#### 2.1 iOS App (Native Application)
```json
{
  "name": "DormWay iOS",
  "type": "Native",
  "callbacks": [
    "dormway://callback",
    "com.dormway.app://callback"
  ],
  "allowed_logout_urls": [
    "dormway://logout",
    "com.dormway.app://logout"
  ],
  "grant_types": [
    "authorization_code",
    "refresh_token"
  ],
  "token_endpoint_auth_method": "none"
}
```

#### 2.2 API (Machine-to-Machine)
```json
{
  "name": "DormWay API",
  "type": "non_interactive",
  "grant_types": ["client_credentials"],
  "scopes": {
    "read:users": "Read user information",
    "write:users": "Update user information",
    "read:campus": "Read campus data",
    "write:campus": "Write campus data"
  }
}
```

#### 2.3 Web Apps (Single Page Application)
```json
{
  "name": "DormWay Web Apps",
  "type": "spa",
  "callbacks": [
    "https://app.dormway.app/callback",
    "http://localhost:3000/callback"
  ],
  "web_origins": [
    "https://app.dormway.app",
    "http://localhost:3000"
  ],
  "allowed_logout_urls": [
    "https://app.dormway.app",
    "http://localhost:3000"
  ]
}
```

### 3. Custom Domain Setup
```
Custom Domain: auth.dormway.app
SSL: Managed by Auth0
CNAME: auth.dormway.app -> dormway.auth0.com
```

### 4. Database Connection
```json
{
  "name": "dormway-users",
  "strategy": "auth0",
  "enabled_clients": ["DormWay iOS", "DormWay Web Apps"],
  "options": {
    "password_policy": "good",
    "password_complexity_options": {
      "min_length": 8
    },
    "disable_signup": false,
    "requires_username": false
  }
}
```

## API Router Integration

### 1. Install Dependencies
```bash
npm install --save @auth0/express-oauth2-jwt-bearer jwks-rsa
```

### 2. Auth Middleware
```typescript
// src/middleware/auth0.ts
import { auth, requiredScopes } from '@auth0/express-oauth2-jwt-bearer';

const checkJwt = auth({
  issuerBaseURL: process.env.AUTH0_ISSUER_BASE_URL,
  audience: process.env.AUTH0_AUDIENCE,
  tokenSigningAlg: 'RS256'
});

export const requireAuth = checkJwt;

export const requireScopes = (scopes: string[]) => {
  return requiredScopes(scopes);
};

// Get user info from token
export const getUserInfo = (req: Request) => {
  const auth = req.auth;
  return {
    userId: auth?.payload.sub,
    email: auth?.payload.email,
    roles: auth?.payload['https://dormway.app/roles'] || []
  };
};
```

### 3. Update Routes
```typescript
// Before (Supabase)
router.get('/profile', requireUser, async (req, res) => {
  const user = await supabase.auth.getUser(req.token);
  // ...
});

// After (Auth0)
router.get('/profile', requireAuth, async (req, res) => {
  const userInfo = getUserInfo(req);
  const user = await getUserFromDatabase(userInfo.userId);
  // ...
});
```

### 4. Environment Variables
```env
# Remove Supabase
# SUPABASE_URL=...
# SUPABASE_ANON_KEY=...
# SUPABASE_SERVICE_KEY=...

# Add Auth0
AUTH0_DOMAIN=dormway.auth0.com
AUTH0_ISSUER_BASE_URL=https://dormway.auth0.com/
AUTH0_AUDIENCE=https://api.dormway.app
AUTH0_CLIENT_ID=your-client-id
AUTH0_CLIENT_SECRET=your-client-secret
```

## iOS App Integration

### 1. Install Auth0 SDK
```swift
// Package.swift or Podfile
dependencies: [
  .package(url: "https://github.com/auth0/Auth0.swift.git", from: "2.5.0")
]
```

### 2. Configure Auth0
```swift
// Auth0Config.swift
import Auth0

struct Auth0Config {
    static let domain = "dormway.auth0.com"
    static let clientId = "your-ios-client-id"
    static let audience = "https://api.dormway.app"
}
```

### 3. Authentication Service
```swift
// AuthService.swift
import Auth0
import Combine

@Observable
class AuthService {
    private let auth0 = Auth0.webAuth()
    private let credentialsManager: CredentialsManager
    
    @Published var isAuthenticated = false
    @Published var user: User?
    
    init() {
        self.credentialsManager = CredentialsManager(authentication: Auth0.authentication())
    }
    
    func login() async throws {
        let credentials = try await auth0
            .audience(Auth0Config.audience)
            .scope("openid profile email offline_access")
            .start()
        
        _ = credentialsManager.store(credentials: credentials)
        self.isAuthenticated = true
        await fetchUserProfile()
    }
    
    func logout() async throws {
        try await auth0
            .clearSession()
        
        _ = credentialsManager.clear()
        self.isAuthenticated = false
        self.user = nil
    }
    
    func getAccessToken() async throws -> String {
        let credentials = try await credentialsManager.credentials()
        return credentials.accessToken
    }
    
    private func fetchUserProfile() async {
        do {
            let accessToken = try await getAccessToken()
            let userInfo = try await Auth0
                .authentication()
                .userInfo(withAccessToken: accessToken)
                .start()
            
            // Map to your User model
            self.user = User(
                id: userInfo.sub,
                email: userInfo.email,
                name: userInfo.name
            )
        } catch {
            print("Failed to fetch user profile: \(error)")
        }
    }
}
```

### 4. Update API Client
```swift
// APIClient.swift
class APIClient {
    private let authService: AuthService
    
    init(authService: AuthService) {
        self.authService = authService
    }
    
    func request<T: Decodable>(_ endpoint: Endpoint) async throws -> T {
        var request = URLRequest(url: endpoint.url)
        
        // Add Auth0 token instead of Supabase
        let token = try await authService.getAccessToken()
        request.setValue("Bearer \(token)", forHTTPHeaderField: "Authorization")
        
        // ... rest of request logic
    }
}
```

## User Migration Strategy

### 1. Export from Supabase
```sql
-- Export users with necessary data
SELECT 
    id,
    email,
    raw_user_meta_data->>'full_name' as name,
    raw_user_meta_data->>'avatar_url' as picture,
    created_at,
    email_confirmed_at,
    role
FROM auth.users
WHERE deleted_at IS NULL;
```

### 2. Transform for Auth0 Import
```javascript
// transform-users.js
const supabaseUsers = require('./supabase-export.json');

const auth0Users = supabaseUsers.map(user => ({
  email: user.email,
  email_verified: !!user.email_confirmed_at,
  user_metadata: {
    supabase_id: user.id,
    full_name: user.name,
    avatar_url: user.picture,
    migrated_at: new Date().toISOString()
  },
  app_metadata: {
    role: user.role,
    migrated: true
  }
}));

// Generate temporary passwords
auth0Users.forEach(user => {
  user.password = generateSecurePassword();
  user.require_password_reset = true;
});
```

### 3. Bulk Import to Auth0
```bash
# Using Auth0 Management API
curl -X POST https://dormway.auth0.com/api/v2/jobs/users-imports \
  -H "Authorization: Bearer YOUR_MGMT_TOKEN" \
  -F users=@auth0-users.json \
  -F connection_id=YOUR_CONNECTION_ID
```

### 4. Update Database References
```sql
-- Add auth0_id column to users table
ALTER TABLE users ADD COLUMN auth0_id VARCHAR(255);

-- Update with mapping from import job
UPDATE users 
SET auth0_id = 'auth0|' || id 
WHERE auth0_id IS NULL;
```

## Testing Plan

### 1. Unit Tests
- Auth middleware validation
- Token parsing and validation
- Scope checking

### 2. Integration Tests
- Login flow (iOS and Web)
- Token refresh
- Logout flow
- API authentication

### 3. E2E Tests
- Complete user journey
- Multi-device scenarios
- Token expiration handling

## Rollout Strategy

### Phase 1: Development Environment
1. Set up Auth0 dev tenant
2. Update services with feature flags
3. Test with team accounts

### Phase 2: Staging Environment  
1. Migrate test users
2. Full integration testing
3. Performance testing

### Phase 3: Production Rollout
1. Gradual rollout (10% -> 50% -> 100%)
2. Monitor error rates
3. Quick rollback capability

## Monitoring

### Key Metrics
- Login success rate
- Token refresh success rate
- API authentication errors
- User migration status

### Alerts
- Failed login rate > 5%
- Token validation errors > 1%
- Any 401/403 spike

## Common Issues and Solutions

### Issue: Token Expiration
```typescript
// Implement token refresh
if (error.status === 401) {
  await refreshToken();
  return retry(request);
}
```

### Issue: CORS Errors
```typescript
// Ensure Auth0 domain is whitelisted
app.use(cors({
  origin: [
    'https://dormway.auth0.com',
    'https://auth.dormway.app'
  ]
}));
```

### Issue: Role/Permission Mismatch
```typescript
// Map Supabase roles to Auth0
const roleMapping = {
  'admin': ['admin', 'user'],
  'user': ['user']
};
```
