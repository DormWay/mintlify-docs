---
title: "Customer.io Template Setup"
description: "This document outlines the Customer.io setup required for end-to-end notification delivery in DormWay. It covers all three notification types: morning briefi..."
---

# Customer.io Template Setup for DormWay Notifications

## Overview
This document outlines the Customer.io setup required for end-to-end notification delivery in DormWay. It covers all three notification types: morning briefing, midday check-in, and evening review.

**Status**: üü° Push notifications ready to test, email templates need creation  
**Priority**: High - Required for notification end-to-end testing  
**Related**: Morning Notification Workflow, Notification Engine Architecture, Midday Check-in Workflow, Evening Review Workflow

## Table of Contents
1. [Push Notifications](#push-notifications-direct-api-with-templates)
2. [Email Templates](#email-templates-transactional-api)
   - [Morning Briefing](#morning-briefing-email-template)
   - [Midday Check-in](#midday-checkin-email-template)
   - [Evening Review](#evening-review-email-template)
3. [Environment Variables](#environment-variables-required)
4. [Sample Test Data](#sample-test-data)
5. [Testing Instructions](#testing-instructions)
6. [Implementation Steps](#implementation-steps)

## Push Notifications (Direct API with Templates)

DormWay uses Customer.io's **direct push API** but still requires template IDs as per their API requirements. The templates act as containers but the content is fully overridden.

### Implementation Status
‚úÖ **Code Updated**: `notificationDeliveryActivities.ts` uses `sendCustomerIODirectPush` with template IDs
‚úÖ **Payload Structure**: Sends complete push payload that overrides template content
‚ùå **Templates Needed**: Must create push templates in Customer.io dashboard

### Push Payload Structure

#### Morning Briefing Example
```typescript
{
  title: "Good morning, Ethan! ‚òÄÔ∏è",
  body: "3 priority items today. Your 9 AM lecture starts in 1 hour. Tap for full briefing & weather.",
  data: {
    type: "morning_briefing",
    notification_id: "uuid-here",
    route: "/dashboard"
  },
  badge: 1,
  sound: "default"
}
```

#### Midday Check-in Example
```typescript
{
  title: "‚ö° Energy check!",
  body: "3 hrs screen time detected. Quick 5-min walk will boost your afternoon focus!",
  data: {
    type: "midday_checkin",
    notification_id: "uuid-here",
    route: "/wellness/checkin",
    action_text: "Take a break"
  },
  badge: 1,
  sound: "default"
}
```

#### Evening Review Example
```typescript
{
  title: "üåô Evening wrap-up ready",
  body: "Great job today! 4 tasks completed. Tap to review your day & prepare for tomorrow.",
  data: {
    type: "evening_review",
    notification_id: "uuid-here",
    route: "/review"
  },
  badge: 1,
  sound: "default"
}
```

### Deep Link Routes
- `/dashboard` - Main dashboard (default)
- `/checkin` - Midday check-in
- `/review` - Evening review
- `/deadlines` - Deadlines view
- `/wellness` - Wellness check

### Push Templates Required

Create these push notification templates in Customer.io:

1. **Morning Briefing Push**
   - Template Name: `Morning Briefing Push`
   - Content: Will be overridden by direct API
   - Note the template ID after creation

2. **Midday Check-in Push**
   - Template Name: `Midday Check-in Push`
   - Content: Will be overridden by direct API
   - Note the template ID after creation

3. **Evening Review Push**
   - Template Name: `Evening Review Push`
   - Content: Will be overridden by direct API
   - Note the template ID after creation

4. **Deadline Reminder Push**
   - Template Name: `Deadline Reminder Push`
   - Content: Will be overridden by direct API
   - Note the template ID after creation

5. **Wellness Check Push**
   - Template Name: `Wellness Check Push`
   - Content: Will be overridden by direct API
   - Note the template ID after creation

## Email Templates (Transactional API)

Email notifications still require Customer.io templates.

### Shared Layout CSS Updates Required

Since Customer.io uses one layout for all emails, add these CSS classes to support all notification types:

```css
/* Generalized Email Components - Works for all notification types */

/* Wellness Check Section (Midday) */
.wellness-check {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.3);
    padding: 16px;
    margin: 12px 0;
    border-radius: 8px;
    border-left: 4px solid #3b82f6;
}

.wellness-metrics {
    display: flex;
    gap: 15px;
    margin: 10px 0;
    flex-wrap: wrap;
}

.wellness-metrics .metric {
    background: rgba(26, 27, 30, 0.8);
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 14px;
    color: #f4f4f6;
}

.energy-high { color: #20b689; font-weight: bold; }
.energy-moderate { color: #ff8e4d; }
.energy-low { color: #dc2626; }

.observation {
    font-style: italic;
    margin-top: 10px;
    color: #999999;
}

/* Suggestion/Recommendation Blocks */
.suggestion {
    background: rgba(32, 182, 137, 0.1);
    border: 1px solid rgba(32, 182, 137, 0.3);
    padding: 16px;
    margin: 10px 0;
    border-radius: 8px;
    border-left: 4px solid #20b689;
}

.time-window {
    color: #999999;
    font-size: 14px;
    margin-bottom: 5px;
}

.alternative {
    font-size: 14px;
    color: #999999;
    margin-top: 8px;
    font-style: italic;
}

/* Movement Section (Midday) */
.movement-section {
    background: rgba(255, 142, 77, 0.1);
    border: 1px solid rgba(255, 142, 77, 0.3);
    padding: 16px;
    margin: 12px 0;
    border-radius: 8px;
    border-left: 4px solid #ff8e4d;
}

.urgent-action {
    background: rgba(220, 38, 38, 0.1);
    padding: 10px;
    margin: 10px 0;
    border-radius: 6px;
    border: 1px solid rgba(220, 38, 38, 0.3);
    color: #f4f4f6;
}

.movement-plan { margin: 10px 0; }
.micro-breaks ul { 
    margin: 5px 0; 
    padding-left: 20px;
    color: #f4f4f6;
}

/* Evening Preview (Midday) */
.evening-preview {
    background: rgba(139, 92, 246, 0.1);
    border: 1px solid rgba(139, 92, 246, 0.3);
    padding: 16px;
    margin: 12px 0;
    border-radius: 8px;
    border-left: 4px solid #8b5cf6;
}

/* Encouragement Block */
.encouragement {
    background: rgba(32, 182, 137, 0.1);
    border: 1px solid rgba(32, 182, 137, 0.3);
    padding: 20px;
    margin: 24px 0;
    border-radius: 12px;
    text-align: center;
    font-style: italic;
}

.encouragement p {
    color: #20b689 !important;
    font-size: 16px;
    font-weight: 500;
    margin: 0;
}

/* Header Variants for Different Notification Types */
.header-morning {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}

.header-midday {
    background: linear-gradient(135deg, #20b689 0%, #16a085 100%) !important;
}

.header-evening {
    background: linear-gradient(135deg, #8b5cf6 0%, #6f42c1 100%) !important;
}

/* Weather Variants */
.weather-morning { 
    background: rgba(102, 209, 255, 0.1);
    border: 1px solid rgba(102, 209, 255, 0.3);
    border-left: 4px solid #66d1ff;
}

.weather-midday { 
    background: rgba(14, 165, 233, 0.1);
    border: 1px solid rgba(14, 165, 233, 0.3);
    border-left: 4px solid #0ea5e9;
}

/* Evening Review Specific Styles */
.day-summary {
    background: rgba(139, 92, 246, 0.1);
    border: 1px solid rgba(139, 92, 246, 0.3);
    padding: 20px;
    margin: 15px 0;
    border-radius: 10px;
    border-left: 4px solid #8b5cf6;
}

.accomplishment-list {
    margin: 15px 0;
}

.accomplishment-item {
    background: rgba(32, 182, 137, 0.1);
    border: 1px solid rgba(32, 182, 137, 0.3);
    padding: 12px;
    margin: 8px 0;
    border-radius: 6px;
    border-left: 3px solid #20b689;
}

.achievement {
    font-weight: bold;
    color: #20b689;
}

.reflection-section {
    background: rgba(255, 142, 77, 0.1);
    border: 1px solid rgba(255, 142, 77, 0.3);
    padding: 16px;
    margin: 15px 0;
    border-radius: 8px;
    border-left: 4px solid #ff8e4d;
}

.tomorrow-prep {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.3);
    padding: 16px;
    margin: 15px 0;
    border-radius: 8px;
    border-left: 4px solid #3b82f6;
}

.prep-item {
    margin: 8px 0;
    padding: 8px;
    background: rgba(26, 27, 30, 0.8);
    border-radius: 6px;
}

.evening-wellness {
    background: rgba(236, 72, 153, 0.1);
    border: 1px solid rgba(236, 72, 153, 0.3);
    padding: 16px;
    margin: 15px 0;
    border-radius: 8px;
    border-left: 4px solid #ec4899;
}

.wind-down-tip {
    font-style: italic;
    color: #999999;
    margin-top: 10px;
}

.productivity-insight {
    background: rgba(99, 102, 241, 0.1);
    border: 1px solid rgba(99, 102, 241, 0.3);
    padding: 12px;
    margin: 10px 0;
    border-radius: 6px;
    text-align: center;
    font-size: 14px;
    color: #a5a7aa;
}
```

### Email Templates

#### Morning Briefing Email Template
**Template Name**: `dormway_morning_briefing_email`

**Subject**: `Your Daily Briefing - \\{\\{ trigger.greeting | truncate: 50 \\}\}`

**Content** (Customer.io uses a layout, so only include the body content):
```html
<div class="header header-morning">
    <h1>üåÖ {{ trigger.greeting }}</h1>
    <p>{{ trigger.day_focus }}</p>
</div>

<div class="weather weather-morning">
    <h3>üå§Ô∏è Today's Weather</h3>
    <p>{{ trigger.weather_summary }}</p>
</div>

{% if trigger.priority_items %}
<h3>üéØ Priority Items</h3>
{% for item in trigger.priority_items %}
<div class="priority-item">
    <strong>{{ item.title }}</strong>
    <p>{{ item.description }}</p>
    {% if item.action_required %}
    <p><em>Action: {{ item.action_required }}</em></p>
    {% endif %}
</div>
{% endfor %}
{% endif %}

{% if trigger.recommendations %}
<h3>üí° Recommendations</h3>
{% for rec in trigger.recommendations %}
<div class="recommendation">
    <strong>{{ rec.suggestion }}</strong>
    <p>{{ rec.reason }}</p>
    {% if rec.action_text %}
    <p><em>{{ rec.action_text }}</em></p>
    {% endif %}
</div>
{% endfor %}
{% endif %}

<div class="motivation">
    <p>{{ trigger.motivation_message }}</p>
</div>

<p class="text-center">
    <a href="https://dormway.app/dashboard" class="button">View Full Briefing</a>
</p>
```

**Important Note**: If the email is showing serif fonts, the issue is likely that:
1. The layout CSS isn't being properly included by Customer.io
2. The font-family declaration in the body style needs to be on the email-content td

To fix the font issue, ensure the layout has this style on the email-content td:
```html
<td class="email-content" style="padding: 32px 24px; background-color: #1a1b1e; font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
```


**Variables**:
- `to` - Recipient email address
- `subject` - Email subject line
- `greeting` - Morning greeting text
- `day_focus` - One-line theme for the day
- `weather_summary` - Weather information
- `priority_items` - Array of priority items with title, description, action_required
- `recommendations` - Array of recommendations with suggestion, reason, action_text
- `motivation_message` - Daily motivation message
- `from` - Sender email (default: "DormWay `<notifications@dormway.app>`")

**Sample Test Data for Morning Briefing**:
```json
{
  "to": "test@example.com",
  "from": "DormWay `<notifications@dormway.app>`",
  "greeting": "Good morning, Ethan! ‚òÄÔ∏è",
  "day_focus": "Today is about balance - academics, wellness, and connection",
  "weather_summary": "Beautiful day ahead! 68¬∞F now, reaching 75¬∞F by afternoon. Perfect for that walk between classes.",
  "priority_items": [
    {
      "title": "EECS 281 Project Due",
      "description": "Final submission at 11:59 PM. You're 95% complete - just need final testing.",
      "action_required": "Run test suite and submit by 10 PM to avoid last-minute stress"
    },
    {
      "title": "MATH 217 Quiz",
      "description": "Linear transformations quiz at 2:00 PM in East Hall 1068",
      "action_required": "Review practice problems from Chapter 4 during lunch"
    },
    {
      "title": "Office Hours Opportunity",
      "description": "Prof. Chen has office hours 3-4 PM, perfect for philosophy essay questions",
      "action_required": "Bring your outline and specific questions about thesis clarity"
    }
  ],
  "recommendations": [
    {
      "suggestion": "Start with 30 minutes of EECS project testing",
      "reason": "Your focus peaks in the morning - use it for your highest priority",
      "action_text": "Block 9:00-9:30 AM for focused testing"
    },
    {
      "suggestion": "Take a 15-minute walk after lunch",
      "reason": "Yesterday's data shows afternoon energy dips without movement breaks",
      "action_text": "Set reminder for 12:45 PM walk to the Diag"
    },
    {
      "suggestion": "Prep for office hours during your 2:30 PM break",
      "reason": "Prepared questions lead to more productive sessions",
      "action_text": "Use the 30 minutes after quiz to organize thoughts"
    }
  ],
  "motivation_message": "You've maintained a great balance this week. Today's the perfect opportunity to finish strong while taking care of yourself. Remember: progress over perfection!",
  "push_notification": {
    "title": "Good morning, Ethan! ‚òÄÔ∏è",
    "body": "3 priority items today. EECS project due tonight (95% done!). Perfect weather for walks.",
    "action_text": "View briefing"
  }
}

#### Midday Check-in Email Template
**Template Name**: `dormway_midday_checkin_email`

**Subject**: `Midday Check-in: {{ trigger.afternoon_focus | truncate: 50 }}`

**Content** (Customer.io uses a layout, so only include the body content):
```html
<div class="header header-midday">
    <h1>üåû {{ trigger.greeting }}</h1>
    <p>{{ trigger.afternoon_focus }}</p>
</div>

<!-- Wellness Check -->
<div class="wellness-check">
    <h3>üí´ How You're Doing</h3>
    <p>{{ trigger.wellness_message }}</p>
    <div class="wellness-metrics">
        <span class="metric energy-{{ trigger.wellness_check.energy_level }}">
            ‚ö° Energy: \{\{ trigger.wellness_check.energy_level | capitalize \}}
        </span>
        <span class="metric">
            üì± Screen Time: \{\{ trigger.wellness_check.screen_time_health | capitalize \}}
        </span>
        <span class="metric">
            üö∂ Movement: \{\{ trigger.wellness_check.movement_urgency | capitalize \}}
        </span>
    </div>
    {% if trigger.wellness_check.key_observation %}
    <p class="observation">{{ trigger.wellness_check.key_observation }}</p>
    {% endif %}
</div>

{% if trigger.weather_update %}
<div class="weather weather-midday">
    <h3>üå§Ô∏è Afternoon Weather</h3>
    <p>{{ trigger.weather_update }}</p>
</div>
{% endif %}

<!-- Afternoon Suggestions -->
{% if trigger.afternoon_suggestions %}
<h3>üéØ Your Afternoon Plan</h3>
{% for suggestion in trigger.afternoon_suggestions %}
<div class="suggestion">
    <div class="time-window">{{ suggestion.time_window }}</div>
    <strong>{{ suggestion.activity }}</strong>
    <p>{{ suggestion.benefit }}</p>
    {% if suggestion.weather_dependent and suggestion.alternative %}
    <p class="alternative"><em>Indoor option: {{ suggestion.alternative }}</em></p>
    {% endif %}
</div>
{% endfor %}
{% endif %}

<!-- Movement Recommendations -->
<div class="movement-section">
    <h3>üí™ Movement & Breaks</h3>
    {% if trigger.movement.immediate_action %}
    <div class="urgent-action">
        <strong>Right now:</strong> {{ trigger.movement.immediate_action.action }} ({{ trigger.movement.immediate_action.duration }})
    </div>
    {% endif %}
    
    <div class="movement-plan">
        <strong>Afternoon activity:</strong> {{ trigger.movement.afternoon_movement.activity }} - {{ trigger.movement.afternoon_movement.duration }}
    </div>
    
    {% if trigger.movement.micro_breaks %}
    <div class="micro-breaks">
        <strong>Screen breaks:</strong>
        <ul>
        {% for break in trigger.movement.micro_breaks %}
            <li>{{ break }}</li>
        {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>

<!-- Evening Preview -->
{% if trigger.evening_preview %}
<div class="evening-preview">
    <h3>üåÖ Looking Ahead</h3>
    {% if trigger.evening_preview.next_event %}
    <p><strong>Next up:</strong> {{ trigger.evening_preview.next_event.title }} at {{ trigger.evening_preview.next_event.time }}</p>
    {% endif %}
    {% if trigger.evening_preview.sunset_time %}
    <p>üåá Sunset at {{ trigger.evening_preview.sunset_time }}</p>
    {% endif %}
    {% if trigger.evening_preview.evening_highlight %}
    <p>{{ trigger.evening_preview.evening_highlight }}</p>
    {% endif %}
</div>
{% endif %}

<div class="encouragement">
    <p>{{ trigger.encouragement }}</p>
</div>

<p class="text-center" style="margin-top: 20px;">
    <a href="https://dormway.app/wellness/checkin" class="button button-success">Complete Check-in</a>
</p>
```


**Variables**:
- `to` - Recipient email address
- `greeting` - Midday greeting text
- `afternoon_focus` - One-line theme for the afternoon
- `wellness_check` - Object with energy_level, screen_time_health, movement_urgency, key_observation
- `wellness_message` - Supportive message about their state
- `weather_update` - Relevant weather for afternoon activities
- `afternoon_suggestions` - Array of suggestions with time_window, activity, benefit, category, weather_dependent, alternative
- `movement` - Object with immediate_action, afternoon_movement, micro_breaks
- `evening_preview` - Object with next_event, sunset_time, evening_highlight
- `encouragement` - Energizing message for the afternoon
- `from` - Sender email (default: "DormWay `<notifications@dormway.app>`")

**Sample Test Data for Midday Check-in**:
```json
{
  "to": "test@example.com",
  "from": "DormWay `<notifications@dormway.app>`",
  "greeting": "Hey there! Hope your day is going well",
  "afternoon_focus": "Balance productivity with self-care this afternoon",
  "wellness_check": {
    "energy_level": "moderate",
    "energy_trend": "declining",
    "screen_time_health": "concerning",
    "movement_urgency": "urgent",
    "mood_indicator": "focused but tired",
    "key_observation": "You've been at your desk for 3 hours straight - your body needs movement"
  },
  "wellness_message": "I noticed you've been deeply focused this morning, which is great! However, your energy seems to be dipping after 3+ hours of continuous screen time.",
  "weather_update": "Beautiful afternoon ahead - 72¬∞F and sunny, perfect for a quick walk!",
  "afternoon_suggestions": [
    {
      "time_window": "2:00-2:30 PM",
      "activity": "Take a 15-minute walk around campus",
      "benefit": "Fresh air and movement will boost your focus for the afternoon study session",
      "category": "movement",
      "weather_dependent": true,
      "alternative": "Do a 10-minute stretching routine in your room"
    },
    {
      "time_window": "3:00-3:15 PM",
      "activity": "Grab a healthy snack and hydrate",
      "benefit": "Stabilize your energy levels and avoid the afternoon crash",
      "category": "wellness",
      "weather_dependent": false,
      "alternative": null
    },
    {
      "time_window": "4:00-5:30 PM",
      "activity": "Deep work session for EECS 281 project",
      "benefit": "Your energy typically peaks again around 4 PM - use it for complex tasks",
      "category": "productivity",
      "weather_dependent": false,
      "alternative": null
    }
  ],
  "movement": {
    "immediate_action": {
      "action": "Stand up and do 5 shoulder rolls",
      "duration": "2 minutes"
    },
    "afternoon_movement": {
      "activity": "Walk to the Diag and back",
      "duration": "15 minutes"
    },
    "micro_breaks": [
      "2:30 PM - Stand and stretch for 2 minutes",
      "3:45 PM - Eye break: Look out window for 20 seconds",
      "5:00 PM - Quick desk yoga stretch"
    ]
  },
  "evening_preview": {
    "next_event": {
      "title": "MATH 217 Study Group",
      "time": "7:00 PM",
      "location": "Shapiro Library"
    },
    "sunset_time": "7:52 PM",
    "evening_highlight": "Perfect evening for outdoor dining - consider eating outside before your study group!"
  },
  "encouragement": "You're making great progress today! A little movement now will help you power through the rest of your tasks with renewed energy.",
  "push_notification": {
    "title": "‚ö° Energy dip detected",
    "body": "3 hrs at desk! Quick 5-min walk = afternoon productivity boost. Perfect weather!",
    "action_text": "Take a break"
  }
}
```

#### Evening Review Email Template
**Template Name**: `dormway_evening_review_email`

**Subject**: `üåô Your Evening Review is Ready`

**Important CSS Note**: If the email appears with serif fonts or broken styling, ensure the Customer.io layout includes proper font-family declarations on the main content container:
```html
<!-- In your Customer.io layout, ensure this style is on the content TD -->
<td style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
```

**Content** (Customer.io uses a layout, so only include the body content):
```html
<div class="header header-evening">
    <h1>üåô {{ trigger.greeting }}</h1>
    <p class="subtitle">{{ trigger.closing_thought }}</p>
</div>

<!-- Day Summary Section -->
<div class="wellness-check">
    <h3>üìä Today's Summary</h3>
    <p>{{ trigger.day_summary }}</p>
</div>

<!-- Accomplishments Section -->
{% if trigger.day_reflection and trigger.day_reflection.top_accomplishments %}
<h3>üåü Today's Wins</h3>
{% for accomplishment in trigger.day_reflection.top_accomplishments %}
<div class="suggestion">
    <div class="category-tag">{{ accomplishment.category }}</div>
    <strong>{{ accomplishment.description }}</strong>
    <p>{{ accomplishment.impact }}</p>
</div>
{% endfor %}
{% endif %}

<!-- Reflection & Gratitude -->
{% if trigger.day_reflection %}
<div class="wellness-check">
    <h3>üí≠ Reflection</h3>
    
    {% if trigger.day_reflection.unexpected_positive %}
    <p><strong>Today's Insight:</strong> {{ trigger.day_reflection.unexpected_positive }}</p>
    {% endif %}
    
    {% if trigger.day_reflection.gratitude_moment %}
    <div class="gratitude-moment">
        <p>üíù {{ trigger.day_reflection.gratitude_moment }}</p>
    </div>
    {% endif %}
    
    {% if trigger.day_reflection.challenges_faced %}
    <p><strong>Challenges Navigated:</strong></p>
    <ul class="challenge-list">
        {% for challenge in trigger.day_reflection.challenges_faced %}
        <li>{{ challenge }}</li>
        {% endfor %}
    </ul>
    {% endif %}
</div>
{% endif %}

<!-- Tomorrow Preview -->
{% if trigger.tomorrow_preview %}
<div class="tomorrow-preview">
    <h3>üåÖ Tomorrow's Game Plan</h3>
    <p>{{ trigger.tomorrow_preview.looking_forward_to }}</p>
    
    {% if trigger.tomorrow_preview.top_priorities %}
    {% for priority in trigger.tomorrow_preview.top_priorities %}
    <div class="prep-item">
        <div class="time-window">{{ priority.time_window }}</div>
        <strong>{{ priority.task }}</strong>
        {% if priority.preparation_tonight %}
        <p class="preparation-tip">üí° Tonight: {{ priority.preparation_tonight }}</p>
        {% endif %}
    </div>
    {% endfor %}
    {% endif %}
    
    <div class="wake-time">
        {% if trigger.tomorrow_preview.wake_time_suggestion %}
        <p>‚è∞ {{ trigger.tomorrow_preview.wake_time_suggestion }}</p>
        {% endif %}
        
        {% if trigger.tomorrow_preview.success_tip %}
        <p class="success-tip">üéØ {{ trigger.tomorrow_preview.success_tip }}</p>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Evening Wind Down -->
<div class="movement-section">
    <h3>üò¥ Wind Down Ritual</h3>
    
    {% if trigger.evening_activities %}
    {% for activity in trigger.evening_activities %}
    <div class="evening-activity">
        <strong>{{ activity.activity }}</strong>
        <span class="duration">{{ activity.duration }}</span>
        <p>{{ activity.benefit }}</p>
    </div>
    {% endfor %}
    {% endif %}
    
    {% if trigger.rest_reminder %}
    <div class="rest-reminder">
        <p>{{ trigger.rest_reminder.suggested_bedtime }}</p>
        <p>{{ trigger.rest_reminder.wind_down_time }}</p>
        {% if trigger.rest_reminder.sleep_quality_tip %}
        <p class="sleep-tip">üí§ {{ trigger.rest_reminder.sleep_quality_tip }}</p>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Personal Growth Note -->
{% if trigger.personal_growth_note %}
<div class="encouragement">
    <p>{{ trigger.personal_growth_note }}</p>
</div>
{% endif %}

<p class="text-center" style="margin-top: 20px;">
    <a href="https://dormway.app/review/{{ trigger.review_id }}" class="button button-primary">Complete Evening Review</a>
</p>
```

**Variables**:
- `to` - Recipient email address
- `greeting` - Evening greeting text
- `day_reflection` - Object containing:
  - `top_accomplishments` - Array with description, impact, category
  - `challenges_faced` - Array of challenge strings
  - `unexpected_positive` - Unexpected positive insight
  - `energy_pattern` - Energy pattern description
  - `gratitude_moment` - Gratitude message
- `day_summary` - Overall day summary text
- `tomorrow_preview` - Object containing:
  - `wake_time_suggestion` - Wake time recommendation
  - `top_priorities` - Array with task, time_window, preparation_tonight
  - `looking_forward_to` - What to look forward to
  - `potential_challenge` - Potential challenge to prepare for
  - `success_tip` - Success tip for tomorrow
- `evening_activities` - Array of activity objects with activity, duration, benefit, category
- `rest_reminder` - Object with suggested_bedtime, wind_down_time, sleep_quality_tip
- `closing_thought` - Inspiring closing message
- `personal_growth_note` - Personal growth insight
- `push_notification` - Object with title, body, action_text (not used in email)
- `from` - Sender email (default: "DormWay `<notifications@dormway.app>`")

**Sample Test Data for Evening Review**:
```json
{
  "to": "test@example.com",
  "from": "DormWay `<notifications@dormway.app>`",
  "greeting": "Good evening, Ethan! As the day comes to a close, it's a moment to reflect on your journey today.",
  "day_reflection": {
    "top_accomplishments": [
      {
        "description": "Maintained a steady productivity score of 0.7.",
        "impact": "This indicates engagement and a good rhythm, even without completed tasks.",
        "category": "Engagement"
      },
      {
        "description": "Navigated the day without major stress spikes.",
        "impact": "This shows resilience and a steady mood, which is vital for long-term well-being.",
        "category": "Emotional Resilience"
      },
      {
        "description": "Kept a balanced energy pattern throughout the day.",
        "impact": "Recognizing your energy levels is essential for managing focus and motivation.",
        "category": "Self-awareness"
      }
    ],
    "challenges_faced": [
      "Absence of completed tasks and social interactions, which could have been discouraging but was met with a positive mindset."
    ],
    "unexpected_positive": "The day offered insights into the importance of setting small, attainable goals, which can help move toward future accomplishments.",
    "energy_pattern": "Steady energy and mood throughout the day, promoting reflection and consideration for future adjustments.",
    "gratitude_moment": "I'm grateful for your ability to remain calm and steady, which undoubtedly sets a foundation for growth."
  },
  "day_summary": "While today may not have seemed traditionally productive, the insights gained and the stability maintained are valuable lessons that can encourage future growth.",
  "tomorrow_preview": {
    "wake_time_suggestion": "Consider waking up at your usual time for consistency.",
    "top_priorities": [
      {
        "task": "Set Small, Attainable Goals",
        "time_window": "Morning",
        "preparation_tonight": "Think of 2-3 small tasks to aim for."
      },
      {
        "task": "Engage in Social Interactions",
        "time_window": "Afternoon or Evening",
        "preparation_tonight": "Identify a friend or colleague to reach out to."
      },
      {
        "task": "Reflect on Your Productivity Patterns",
        "time_window": "Evening",
        "preparation_tonight": "Set aside time for a brief reflection on your day."
      }
    ],
    "looking_forward_to": "Tomorrow is a new opportunity to reset and create a fulfilling day with attainable goals.",
    "potential_challenge": "Maintaining focus and motivation might be a challenge, so prepare reminders for your tasks.",
    "success_tip": "Utilize a strategic planning session at the beginning or end of the day to optimize your time effectively."
  },
  "evening_activities": [
    {
      "activity": "Light Stretching or Mindful Walk",
      "duration": "20-30 minutes",
      "benefit": "Helps unwind and release tension after the day.",
      "category": "Relaxation"
    },
    {
      "activity": "Journaling Session",
      "duration": "15-20 minutes",
      "benefit": "Provides reflection and preparation for tomorrow.",
      "category": "Reflection"
    },
    {
      "activity": "Connect with a Friend or Family Member",
      "duration": "15-30 minutes",
      "benefit": "Boosts mood and provides social connection.",
      "category": "Social Interaction"
    }
  ],
  "rest_reminder": {
    "suggested_bedtime": "Aim to go to bed by your usual time.",
    "wind_down_time": "Take some quiet time to transition before sleep.",
    "sleep_quality_tip": "Keep your phone away to ensure a restful night."
  },
  "closing_thought": "Each day has value, and today's experience can guide you toward a more fulfilling tomorrow. Embrace the possibilities ahead!",
  "personal_growth_note": "Recognize that today's steady pace can provide the foundation for future successes.",
  "push_notification": {
    "title": "üåô Time to unwind",
    "body": "Today brought steady energy and mood. Reflect on your day before resting well.",
    "action_text": "üìù Quick reflection?"
  }
}
```

## Push Notification Templates

Push notifications use Customer.io's Direct Push API, not transactional messages. The templates are defined in code with the following structure:

### Morning Push
```json
{
    "title": "üåô Evening wrap-up ready",
    "body": "Great job! 8 tasks done. Review your day.",
    "action_text": "Review day"
  }
}
```

## Context Data for AI Crew Generation

This section documents what user context data is aggregated and passed to each AI crew for generating personalized notifications.

### Morning Briefing Context

The morning briefing crew receives comprehensive context to start the day:

**Aggregation Settings**:
```javascript
{
  userDataDays: 3,        // Past 3 days of user behavior
  campusEventsLimit: 15,  // Today's campus events
  cityDataLimit: 3,       // Weather and city info
  includeWeather: true,
  includeCampusEvents: true,
  includeCityContext: true
}
```

**Context Structure**:
```javascript
{
  user: {
    id: "user-id",
    name: "Student Name",
    ai_personality: {              // User's configured AI personality
      communicationTone: "friendly",
      helpfulnessLevel: "balanced",
      personalityStyle: "encouraging"
    },
    current_location: "dorm_room",
    current_activity: "waking_up",
    notification_preferences: {...}
  },
  temporal: {
    current_time: "2025-07-17T08:00:00Z",
    day_of_week: 3,                // 0-6
    week_in_semester: 8,
    is_weekend: false,
    is_exam_period: false,
    timezone: "America/New_York"
  },
  academic: {
    upcoming_deadlines: [           // Next 7 days
      {
        title: "EECS 281 Project 3",
        course_code: "EECS 281",
        due_date: "2025-07-20T23:59:00Z",
        hours_until_due: 72,
        weight: "15%",
        completion_estimate_hours: 12,
        current_progress: 0.4
      }
    ],
    todays_classes: [
      {
        course_code: "EECS 281",
        course_name: "Data Structures",
        type: "lecture",
        start_time: "09:00",
        location: "EECS 1311",
        instructor: "Dr. Smith"
      }
    ],
    at_risk_courses: [],
    study_streak: 5,
    current_gpa: 3.75
  },
  environmental: {
    weather: {
      temperature: 72,              // Fahrenheit
      condition: "sunny",
      feels_like: 70,
      humidity: 45,
      wind_speed: 5,
      precipitation_chance: 10,
      sunrise: "06:12",
      sunset: "20:45"
    },
    campus_events: [
      {
        title: "Career Fair",
        category: "professional",
        location: "Union Ballroom",
        start_time: "10:00",
        relevance: 0.9              // AI-calculated relevance
      }
    ],
    building_occupancy: "moderate"
  },
  behavioral: {
    last_app_open: "2025-07-16T22:30:00Z",
    engagement_score: 0.8,
    preferred_study_times: ["14:00-17:00", "20:00-23:00"],
    average_study_duration: 2.5,    // hours
    notification_history: [...]     // Recent notifications
  }
}
```

### Midday Check-in Context

The midday check-in focuses on current state and afternoon planning:

**Aggregation Settings**:
```javascript
{
  userDataDays: 1,        // Just today's data
  campusEventsLimit: 10,  // Afternoon/evening events
  cityDataLimit: 2,       
  includeWeather: true,   // For afternoon activities
  includeCampusEvents: true,
  includeCityContext: false
}
```

**Additional Context Fields**:
```javascript
{
  behavioral: {
    morning_activity: {
      screen_time_minutes: 180,
      active_minutes: 15,
      locations_visited: ["dorm", "library", "dining_hall"],
      classes_attended: 2,
      tasks_completed: 3
    },
    current_energy_estimate: "moderate",  // Based on activity patterns
    sedentary_minutes: 120,
    last_movement: "12:30"
  },
  health: {
    steps_today: 3500,
    active_minutes_today: 25,
    current_stress_level: "moderate",    // From wearables if available
    hydration_reminders: 2
  }
}
```

### Evening Review Context

The evening review focuses on reflection and tomorrow preparation:

**Aggregation Settings**:
```javascript
{
  userDataDays: 1,        // Today only for reflection
  campusEventsLimit: 5,   // Tomorrow's events
  cityDataLimit: 1,
  includeWeather: false,  // Less relevant at night
  includeCampusEvents: true,
  includeCityContext: false
}
```

**Additional Context Fields**:
```javascript
{
  behavioral: {
    day_activity: {
      tasks_completed: 8,
      classes_attended: 4,
      study_sessions: 2,
      social_interactions: 3,
      screen_time_hours: 6.5,
      productivity_score: 0.75
    },
    energy_pattern: "steady_throughout",  // morning_peak, evening_surge, etc.
    mood_trajectory: "positive"           // Based on activity patterns
  },
  academic: {
    todays_accomplishments: [
      {
        description: "Completed EECS 281 project milestone",
        category: "academic"
      }
    ],
    tomorrow_schedule: [
      {
        time: "09:00",
        title: "MATH 217 Lecture",
        type: "class",
        location: "East Hall 1324"
      }
    ]
  },
  wellness: {
    todays_steps: 8243,
    active_minutes: 45,
    sleep_last_night: {
      duration_hours: 7.2,
      quality: "good"
    },
    meals_logged: 3
  },
  environmental: {
    tomorrows_weather: {
      condition: "partly_cloudy",
      high: 75,
      low: 58
    },
    campus_events_tomorrow: [...]
  }
}
```

### Key Context Elements Used Across All Notifications

1. **AI Personality** - Always included to maintain consistent tone:
   - `communication_tone`: casual, friendly, professional, enthusiastic
   - `personality_style`: encouraging, direct, humorous, supportive
   - `helpfulness_level`: minimal, balanced, detailed

2. **User Preferences** - Respected for delivery decisions:
   - Quiet hours
   - Preferred notification times
   - Channel preferences (push/email/in-app)
   - Notification categories enabled/disabled

3. **Temporal Context** - Critical for appropriate messaging:
   - Current time and day
   - Weekend vs weekday
   - Exam periods
   - Semester progress

4. **Academic Context** - Core to all notifications:
   - Upcoming deadlines (with urgency calculation)
   - Today's schedule
   - Course performance indicators
   - Study patterns

5. **Behavioral Patterns** - For personalization:
   - App engagement history
   - Study time preferences
   - Activity patterns
   - Response to previous notifications

The AI crews use this rich context to generate highly personalized content that reflects the user's current situation, preferences, and configured AI personality. The hallucination guardrail ensures that crews don't invent fake deadlines or events when contexts are empty.

## Environment Variables Required

Add these to Doppler dev config after creating templates:

### Push Template IDs
```bash
CUSTOMERIO_MORNING_BRIEFING_PUSH_TEMPLATE_ID="<template_id_from_customerio>"
CUSTOMERIO_MIDDAY_CHECKIN_PUSH_TEMPLATE_ID="<template_id_from_customerio>"
CUSTOMERIO_EVENING_REVIEW_PUSH_TEMPLATE_ID="<template_id_from_customerio>"
CUSTOMERIO_DEADLINE_REMINDER_PUSH_TEMPLATE_ID="<template_id_from_customerio>"
CUSTOMERIO_WELLNESS_CHECK_PUSH_TEMPLATE_ID="<template_id_from_customerio>"
```

### Email Template IDs
```bash
CUSTOMERIO_MORNING_BRIEFING_EMAIL_TEMPLATE_ID="<template_id_from_customerio>"
CUSTOMERIO_MIDDAY_CHECKIN_EMAIL_TEMPLATE_ID="<template_id_from_customerio>"
CUSTOMERIO_EVENING_REVIEW_EMAIL_TEMPLATE_ID="<template_id_from_customerio>"
CUSTOMERIO_DEADLINE_REMINDER_EMAIL_TEMPLATE_ID="<template_id_from_customerio>"
CUSTOMERIO_WELLNESS_CHECK_EMAIL_TEMPLATE_ID="<template_id_from_customerio>"
```

## Implementation Steps

### 1. Create Templates in Customer.io Dashboard
- [x] Access Customer.io dashboard
- [x] Create push notification template with variables above
- [x] Create email template with HTML above
- [x] Note down template IDs

### 2. Add Template IDs to Environment
- [x] Add template IDs to Doppler dev config
- [x] Verify environment variables are available in engine

### 3. Enable Customer.io Delivery
- [ ] Uncomment Customer.io code in `notificationDeliveryActivities.ts`
- [ ] Test template variable mapping

### 4. Device Registration
- [ ] Ensure iOS app registers device token with Customer.io
- [ ] Verify user ID matches between app and engine (`bcb74531-18e4-48c0-91fb-927f211c43bb`)

### 5. End-to-End Testing
- [ ] Run morning notification workflow
- [ ] Verify push notification delivery to device
- [ ] Verify email delivery to inbox
- [ ] Check Customer.io logs for delivery status

## Sample Test Data

### Complete Test Data for All Notification Types

This section provides comprehensive test data that can be used with the Customer.io API or test scripts. All data is formatted to match the exact structure expected by the Customer.io templates.

#### Morning Briefing Test Data
See the complete test data in the [Morning Briefing Email Template](#morning-briefing-email-template) section above.

#### Midday Check-in Test Data  
See the complete test data in the [Midday Check-in Email Template](#midday-checkin-email-template) section above.

#### Evening Review Test Data
See the complete test data in the [Evening Review Email Template](#evening-review-email-template) section above.

### Quick Test Payloads

For quick testing via API or scripts, here are minimal valid payloads:

#### Minimal Morning Notification
```json
{
  "to": "test@example.com",
  "greeting": "Good morning!",
  "day_focus": "Focus on productivity",
  "weather_summary": "Sunny, 72¬∞F",
  "priority_items": [
    {
      "title": "EECS 281 Lecture",
      "description": "9:00 AM in EECS 1311"
    }
  ],
  "motivation_message": "You've got this!"
}
```

#### Minimal Midday Check-in
```json
{
  "to": "test@example.com",
  "greeting": "Hey there!",
  "afternoon_focus": "Stay energized",
  "wellness_check": {
    "energy_level": "moderate",
    "screen_time_health": "good",
    "movement_urgency": "low"
  },
  "wellness_message": "You're doing great!",
  "encouragement": "Keep up the momentum!"
}
```

#### Minimal Evening Review
```json
{
  "to": "test@example.com",
  "greeting": "Great job today!",
  "day_theme": "Productive day",
  "summary_message": "You accomplished your goals",
  "day_stats": {
    "tasks_completed": 5,
    "study_hours": 4,
    "steps": 6000,
    "screen_time": "5h 30m"
  },
  "closing_message": "Rest well!"
}
```

### Simplified Evening Review for CSS Testing

If the full evening review data is causing CSS issues, start with this simplified version:

```json
{
  "to": "test@example.com",
  "from": "DormWay `<notifications@dormway.app>`",
  "greeting": "Evening, Ethan!",
  "day_theme": "Productive Tuesday",
  "summary_message": "Great progress on your goals today.",
  "day_stats": {
    "tasks_completed": 5,
    "study_hours": 4
  },
  "accomplishments": [
    {
      "achievement": "Finished Math homework",
      "impact": "Ready for tomorrow's quiz"
    }
  ],
  "reflection": {
    "insight": "Your morning study session was very productive"
  },
  "tomorrow_prep": {
    "overview": "Light day tomorrow - 2 classes"
  },
  "wellness_recommendation": "Time to wind down with some light reading.",
  "wind_down_suggestions": ["Read a book", "Light stretching"],
  "ideal_bedtime": "11:00 PM",
  "closing_message": "Sleep well!"
}
```

## Testing Instructions

### 1. Test Scripts Available

The engine provides test scripts for each notification type:

#### Morning Notification Test
```bash
cd engine
npm run test:morning-notification
```

#### Midday Check-in Test
```bash
cd engine
npm run test:midday-notification
```

#### Evening Review Test
```bash
cd engine
npm run test:evening-notification  # When implemented
```

### 2. Manual Testing with Customer.io

#### Prerequisites
1. Ensure templates are created in Customer.io dashboard
2. Add template IDs to Doppler environment
3. Verify your test device is registered with Customer.io
4. Enable real Customer.io delivery in `notificationDeliveryActivities.ts`

#### Test Process
1. **Run the test script** for the notification type you want to test
2. **Monitor logs** for successful delivery confirmation
3. **Check your device** for push notification (should arrive within 30 seconds)
4. **Check your email** for email notification
5. **Verify in Customer.io dashboard** under Deliveries section

### 3. Testing with Custom Data

You can test with custom data by modifying the test scripts or using the Temporal UI:

```typescript
// Example: Testing morning notification with custom data
const testInput = {
  studentId: "bcb74531-18e4-48c0-91fb-927f211c43bb",
  scheduledTime: new Date().toISOString(),
  context: {
    weather: { temperature: 45, condition: "rainy" },
    calendar: { firstEventTime: "10:00 AM", eventCount: 3 },
    // ... other context data
  }
};
```

### 4. Validating Template Variables

Before sending to Customer.io, validate that all required template variables are present:

1. Check the generated notification payload in logs
2. Compare against the template variables documented above
3. Ensure no undefined or null values for required fields

## Current Status

**Code Status**: 
- ‚úÖ Morning notification workflow generates notifications correctly
- ‚úÖ Midday notification workflow and crew implemented
- ‚úÖ Hallucination guardrail implemented
- ‚úÖ Customer.io integration code exists
- ‚úÖ Email templates documented for all three notification types
- ‚ùå Templates not created in Customer.io
- ‚ùå Template IDs not in environment variables

**Testing Status**:
- ‚úÖ Simulated delivery working
- ‚úÖ Morning notifications end-to-end tested
- ‚ùå Midday notifications not tested
- ‚ùå Evening notifications not implemented
- ‚ùå Real Customer.io delivery not tested

## Device Registration Requirements

For push notifications to work, the iOS app must:
1. Request push notification permissions
2. Register device token with Customer.io on app launch
3. Associate device token with user ID `bcb74531-18e4-48c0-91fb-927f211c43bb`

## Troubleshooting

### No Push Notification Received
1. Check Customer.io delivery logs
2. Verify device token is registered for user
3. Check push notification permissions in iOS app
4. Verify template variables match sent data

### No Email Received  
1. Check Customer.io delivery logs
2. Verify email address in user profile
3. Check spam folder
4. Verify template variables match sent data

### Template Variable Errors
1. Check Customer.io template syntax
2. Compare variables in template vs. sent data
3. Check Customer.io error logs

## Next Steps

1. **Immediate**: Create Customer.io templates and get template IDs
2. **Add template IDs to Doppler environment**
3. **Enable real delivery in code**
4. **Test end-to-end with your device**

## Template Design Guidelines

### Visual Consistency
1. **Color Scheme**: Each notification type has a distinct color palette:
   - Morning: Purple gradient (#667eea ‚Üí #764ba2)
   - Midday: Teal gradient (#20b689 ‚Üí #16a085)  
   - Evening: Violet gradient (#8b5cf6 ‚Üí #6f42c1)

2. **Typography**: Consistent use of SF Pro Display font family across all templates

3. **Component Styling**: Reusable CSS classes for common elements:
   - `.wellness-check` - Health and energy status blocks
   - `.suggestion` - Activity recommendation blocks
   - `.accomplishment-item` - Achievement highlights
   - `.encouragement` - Motivational message blocks

### Content Guidelines
1. **Tone**: Supportive, encouraging, and personalized
2. **Length**: Keep sections concise - users should be able to scan quickly
3. **Emojis**: Used sparingly for visual breaks and emotional connection
4. **Personalization**: Always use the student's name and contextual data

### Template Variables Best Practices
1. **Always provide defaults** for optional fields in your code
2. **Validate data types** before sending to Customer.io
3. **Escape special characters** in user-generated content
4. **Use consistent date/time formatting** across all templates

### Performance Considerations
1. **Image Usage**: Minimize images to ensure fast email loading
2. **Mobile Optimization**: All templates must be responsive
3. **Preheader Text**: Use the subject line truncation effectively
4. **Call-to-Action**: Clear, prominent buttons for primary actions

## Related Documentation

- Notification Engine Architecture
- Morning Notification Workflow  
- Midday Check-in Workflow
- Evening Review Workflow
- Customer.io Integration Guide
- [Customer.io Platform Configuration Guide](/docs/engineering/technical/customerio/customerio-platform-configuration-guide)
- Push Notification Setup
