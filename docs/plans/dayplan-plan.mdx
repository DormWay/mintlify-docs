---
title: "DayPlan Plan"
description: "What it does **not** do:"
---

## 1. What DayPlan _is_ (for a student)

**One-line definition:**

> DayPlan is your **daily priority brief**, not a babysitter. It tells you what _actually matters today_ (deadlines, classes, conflicts, best work windows), then shuts up.

What it does **not** do:

- Doesn‚Äôt tell you when to eat, sleep, ‚Äúgo for a walk.‚Äù
    
- Doesn‚Äôt script every hour.
    
- Doesn‚Äôt lecture you with generic wellness quotes.
    

What it _does_ do:

- Shows **what‚Äôs due**, **where you need to be**, **what might blow up**, and **one or two smart suggestions** to move the needle.
    

---

## 2. The core experience

### 2.1 The ‚ÄúToday‚Äù Web View (canonical DayPlan)

This is the main place students land when they click from email or pin DormWay as a homepage.

Think of it as a **single scroll**, clean layout, no full-page background image.

---

#### A. Top: Header strip

- **Date + Day**: `Tuesday ¬∑ November 18`
    
- **Greeting**: `Hey Riley üëã`
    
- **Vibe tag**: Small pill, derived from schedule load:
    
    - `Light day`
        
    - `Steady day`
        
    - `Big day`
        

Under that, **one-line summary**, e.g.:

> ‚ÄúBig day: COMM quiz due tonight and back-to-back classes 11:30‚Äì4:00.‚Äù

Reasoning:  
Gen Z students want **instant context**: ‚ÄúIs today chill or chaos?‚Äù One glance, not paragraphs.

---

#### B. Section 1: ‚ÄúDue Today‚Äù (Always first)

Title: `üö® Due today`

Content style (very tight):

- `COMM 230 ‚Äì Quiz 3 ¬∑ 10:00 PM ¬∑ Not submitted`
    
- `ASTRO 104 ‚Äì Problem Set 4 ¬∑ 5:00 PM ¬∑ In progress`
    

Each item has:

- Course tag
    
- Assignment name
    
- **Due time**
    
- Submission status if you can see it from Canvas.
    

Optional: tiny chip like `High priority` if it‚Äôs big (exam / big project).

Reasoning:  
This is the **single most important thing** students care about. It‚Äôs not obvious from normal calendars. Putting it first respects that priorities > everything.

---

#### C. Section 2: ‚ÄúToday‚Äôs Schedule‚Äù (Just the essentials)

Title: `üìö Today‚Äôs schedule`

Layout: simple list, no timeline bars needed at first.

Example:

- `11:30‚Äì12:50 ¬∑ COMM 230 ¬∑ North Quad 1255`
    
- `4:00‚Äì5:30 ¬∑ ASTRO 104 ¬∑ Angell Hall A102`
    
- `7:00‚Äì8:00 ¬∑ Study group ¬∑ UGLi 3rd floor`
    

Key design choices:

- **Start‚Äìend times**, not just start.
    
- Building/room included.
    
- Icon per type (class / exam / event / work).
    

What‚Äôs _not_ here:

- Breakfast, lunch, ‚Äúwind down,‚Äù ‚Äúevening walk,‚Äù ‚Äúfree time.‚Äù
    

Reasoning:  
They already use Google Calendar. This list is a **clean reference**, not a re-skin of their whole life.

---

#### D. Section 3: ‚ÄúConflicts & gotchas‚Äù (Only if needed)

Title: `‚ö† Heads up`

Only shows if something is actually off.

Example:

- `Office hours 2‚Äì3 PM overlap with ASTRO 104 2:30‚Äì4 PM ‚Äì you‚Äôll have to choose or arrive late.`
    
- `You‚Äôve got a 10-minute gap between North Quad and Central Campus class ‚Äì tight walk, leave on time.`
    

Reasoning:  
This is where AI actually feels useful, not annoying‚Äîcalling out **stuff they might not notice**. If there‚Äôs nothing, this section **doesn‚Äôt appear at all**.

---

#### E. Section 4: ‚ÄúSuggested moves‚Äù (Optional, clearly suggestions)

Title: `üí° Suggested moves for today`  
Subtext: `These are suggestions, not a schedule. Edit or ignore freely.`

Example items:

- `2:00‚Äì3:00 PM ¬∑ COMM 230 quiz prep ¬∑ Use this gap after class for a focused block.`
    
- `7:30‚Äì8:00 PM ¬∑ ASTRO 104 problem set check ¬∑ Quick pass before the 5 PM deadline tomorrow.`
    

UI: Each suggestion has:

- Time range
    
- What to do
    
- Tiny action chips:
    
    - `[Accept]` ‚Üí adds to calendar (or marks as ‚Äúplanning to do‚Äù)
        
    - `[Snooze]` ‚Üí moves suggestion later
        
    - `[Dismiss]` ‚Üí hides it / trains future suggestions
        

Reasoning:  
Students like **smart nudges**, not being told ‚Äúyou will study from X‚ÄìY.‚Äù Explicitly calling them _suggestions_ and giving ‚Äúdismiss‚Äù makes it feel collaborative, not controlling.

---

#### F. Section 5: ‚ÄúComing up‚Äù (Very short)

Title: `üìÖ Coming up (next 2‚Äì3 days)`

Example:

- `Tomorrow ¬∑ ASTRO 104 ‚Äì Problem Set 4 ¬∑ 5:00 PM`
    
- `Thursday ¬∑ COMM 230 ‚Äì Ad Campaign Outline ¬∑ 11:59 PM`
    

Max 2‚Äì3 items. If nothing big is coming, this section disappears.

Reasoning:  
Enough look-ahead to reduce anxiety and avoid getting blindsided, without throwing the whole semester at them every morning.

---

#### G. Section 6: Quick actions bar

At the bottom or top as a sticky bar:

- `+ Add personal task`
    
- `View full calendar`
    
- `Adjust DayPlan settings`
    
- `Mark today as done` (end-of-day emotional closure, lol)
    

---

### 2.2 Email Digest (while you don‚Äôt have apps)

This is a **compressed mirror** of the Today view.

**Subject lines (examples):**

- If something is due:  
    `Due today: COMM quiz at 10 PM`
    
- If nothing due, just classes:  
    `2 classes today ¬∑ light schedule`
    
- If heavy:  
    `Big day: 3 classes + essay due tonight`
    

**Body example:**

```text
Subject: Due today: COMM quiz at 10 PM

Morning, Riley üëã

üö® DUE TODAY
‚Ä¢ COMM 230 ‚Äì Quiz 3 ¬∑ 10:00 PM ¬∑ Not submitted

üìö CLASSES
‚Ä¢ 11:30‚Äì12:50 ¬∑ COMM 230 ¬∑ North Quad 1255
‚Ä¢ 4:00‚Äì5:30 ¬∑ ASTRO 104 ¬∑ Angell Hall A102

üí° Suggested move
‚Ä¢ 2:00‚Äì3:00 PM ‚Äì COMM 230 quiz prep (gap between classes)

üìÖ COMING UP
‚Ä¢ Tomorrow: ASTRO 104 ‚Äì Problem Set 4 ¬∑ 5:00 PM

View today in DormWay ‚Üí
```

No full-page background. Simple, high contrast, mobile-friendly.

Reading time: 5‚Äì10 seconds.

Reasoning:  
Gen Z doesn‚Äôt want novels in email. The email is a **ping + preview**, not the main experience. ‚ÄúView today‚Äù takes them into the real, interactive /today page.

---

### 2.3 Notifications (future but conceptually aligned)

When you have mobile/native or at least web push:

- **Morning summary (8 AM)**
    
    > `Today: COMM quiz due at 10 PM, 2 classes, good work window 2‚Äì3 PM.`
    
- **Pre-class reminder (optional)**
    
    > `COMM 230 in 30 minutes ‚Äì North Quad 1255.`
    
- **Deadline reminder**
    
    > `COMM 230 Quiz 3 due in 2 hours ‚Äì not submitted yet.`
    

All of these obey preferences (see below).

---

## 3. Customization & Gen Z preferences

Think of a **DayPlan Settings** sheet with a few clear control groups.

### 3.1 Mode: how intense is this thing?

**1. Minimal mode (default for many)**

> ‚ÄúJust tell me what‚Äôs due and my classes.‚Äù

- Shows:
    
    - `Due today`
        
    - `Today‚Äôs schedule`
        
    - `Coming up`
        
- Hides:
    
    - Suggestions
        
    - Conflicts (unless serious, like double booking)
        
    - All wellness/meal-related anything
        

**2. Focused mode**

> ‚ÄúHelp me be strategic, not micromanaged.‚Äù

- Shows:
    
    - Everything Minimal has
        
    - `Suggested moves`
        
    - `Conflicts & gotchas`
        

**3. Coach mode** (opt-in)

> ‚ÄúI want more structure and nudges.‚Äù

- Can include:
    
    - Slightly more detailed suggested blocks
        
    - Optional tags like ‚ÄúTry to be off screens by midnight,‚Äù but still context-specific.
        
- Still **never** pre-schedules meals or free time unless the user explicitly asks for that.
    

Reasoning:  
Different students are in different mental states. Some just want raw info; some want ‚Äúsoft accountability.‚Äù Modes let them self-sort without you forcing a one-size-fits-all vibe.

---

### 3.2 What content to include

Toggles like:

- `[x] Show assignments due today`
    
- `[x] Show classes/events`
    
- `[ ] Show generic wellness tips` (default OFF)
    
- `[ ] Show suggested study blocks`
    
- `[ ] Email me on light days (no big deadlines)`
    

Students can tune it once and forget it.

---

### 3.3 Timing preferences

Options like:

- **When to get the daily email:**
    
    - `Night before (8‚Äì10 PM)`
        
    - `Morning (7‚Äì9 AM)`
        
    - `Only on days with deadlines`
        
    - `Never (I‚Äôll just use the web app)`
        

Reasoning:  
Some people like to plan at night, some in the morning, some hate email and just want the /today view when they open their laptop.

---

## 4. Accessibility & inclusion

This is one of those things you only notice if it‚Äôs bad.

### 4.1 Visual accessibility

- **Light & dark mode** (stick to neutral backgrounds, no wild gradients for core content).
    
- WCAG-compliant contrast for text and status chips.
    
- Never rely on color alone to convey meaning:
    
    - `‚ö†` + text for conflicts
        
    - `üö®` for due-today items.
        

### 4.2 Cognitive accessibility / anxiety-friendly

- Avoid urgent but vague language (‚ÄúYour day is intense!!‚Äù).
    
- Use **specific, calm phrasing**:
    
    - Good: `‚ÄúToday is busier than usual: 3 classes + essay due at 11:59 PM.‚Äù`
        
    - Bad: `‚ÄúCRAZY DAY AHEAD üò±‚Äù`
        
- Let users:
    
    - Hide certain sections (e.g., ‚ÄúDon‚Äôt show GPA/grade-related info here, just tasks‚Äù).
        
    - Collapse ‚ÄúComing up‚Äù if future stuff is overwhelming.
        

### 4.3 Keyboard & screen reader support

Conceptually:

- All sections labeled with headings (`Due today`, `Today‚Äôs schedule`, etc.).
    
- Items in lists have consistent structure: time ‚Üí course ‚Üí title ‚Üí location ‚Üí status.
    
- ‚ÄúSuggested moves‚Äù clearly labeled as suggestions in text for screen readers.
    

### 4.4 Customizable density

Some students like minimal; some want more detail.

- Simple toggle: `Compact list` vs `Detailed list`
    
    - Compact: Just course + due time.
        
    - Detailed: Add description, link to Canvas, etc.
        

---

## 5. Concrete example: One full day for a fictional student

Let‚Äôs pretend we‚Äôre building this for **Taylor**, a sophomore.

### Taylor‚Äôs actual world today

- Classes:
    
    - 9:00‚Äì10:30 ¬∑ STATS 250
        
    - 11:30‚Äì12:50 ¬∑ COMM 230
        
- Deadlines:
    
    - COMM 230 Quiz 3 due 10 PM (not started)
        
    - ASTRO 104 reading due tomorrow 5 PM
        
- Events:
    
    - 7:00‚Äì8:00 PM study group at UGLi
        

Taylor has DayPlan in **Focused mode** with suggestions on, wellness off.

---

### How DayPlan renders this:

#### Email (8:00 AM)

> **Subject:** Due today: COMM quiz at 10 PM
> 
> Morning, Taylor üëã
> 
> üö® DUE TODAY  
> ‚Ä¢ COMM 230 ‚Äì Quiz 3 ¬∑ 10:00 PM ¬∑ Not submitted
> 
> üìö TODAY‚ÄôS SCHEDULE  
> ‚Ä¢ 9:00‚Äì10:30 ¬∑ STATS 250 ¬∑ Mason Hall 2305  
> ‚Ä¢ 11:30‚Äì12:50 ¬∑ COMM 230 ¬∑ North Quad 1255  
> ‚Ä¢ 7:00‚Äì8:00 ¬∑ Study group ¬∑ UGLi 3rd floor
> 
> üí° SUGGESTED MOVE  
> ‚Ä¢ 2:00‚Äì3:00 PM ‚Äì COMM 230 quiz prep (open gap, good focus window)
> 
> üìÖ COMING UP  
> ‚Ä¢ Tomorrow: ASTRO 104 reading ¬∑ 5:00 PM
> 
> View today in DormWay ‚Üí

Taylor taps ‚ÄúView today‚Äù.

---

#### ‚ÄúToday‚Äù web view

**Header:**

> `Tuesday ¬∑ November 18`  
> `Hey Taylor üëã`  
> `Steady day`  
> `You‚Äôve got 2 classes and 1 quiz due tonight ‚Äì best work window is 2‚Äì3 PM.`

---

**Section: üö® Due today**

- `COMM 230 ‚Äì Quiz 3 ¬∑ 10:00 PM ¬∑ Not submitted`
    

If Taylor clicks it:

- See link to Canvas
    
- See estimated time: ‚ÄúEst. 30‚Äì45 mins based on past quizzes‚Äù
    

---

**Section: üìö Today‚Äôs schedule**

- `9:00‚Äì10:30 ¬∑ STATS 250 ¬∑ Mason Hall 2305`
    
- `11:30‚Äì12:50 ¬∑ COMM 230 ¬∑ North Quad 1255`
    
- `7:00‚Äì8:00 ¬∑ Study group ¬∑ UGLi 3rd floor`
    

Below the list: subtle caption:

> ‚ÄúTravel time between your classes looks normal today.‚Äù

So they know nothing is scary there.

---

**Section: ‚ö† Heads up**

Maybe there is none today ‚Üí section is completely hidden.  
If something appears, it‚Äôs meaningful.

---

**Section: üí° Suggested moves**

- `2:00‚Äì3:00 PM ‚Äì COMM 230 quiz prep ¬∑ Use this gap to knock it out before evening. [Accept] [Later] [Dismiss]`
    

Taylor clicks `[Accept]`:

- That block shows as ‚Äúplanned‚Äù (maybe a subtle highlight).
    
- In future, DayPlan learns Taylor likes 2‚Äì3 PM blocks and suggests similar windows.
    

---

**Section: üìÖ Coming up**

- `Tomorrow ¬∑ ASTRO 104 ‚Äì Reading Quiz ¬∑ 5:00 PM`
    
- `Thursday ¬∑ COMM 230 ‚Äì Ad Campaign Outline ¬∑ 11:59 PM`
    

Below that: small toggle  
`[Hide upcoming for now]`

Taylor can hide it if they‚Äôre overwhelmed by future stuff; DayPlan remembers this preference.

---

## 6. Why this works (reasoning)

- **Aligns with Gen Z attention**  
    10‚Äì15 seconds to understand the day. Emojis and icons used as signposts, not decoration.
    
- **Respects autonomy**
    
    - No ‚Äúwind down routine‚Äù events.
        
    - No ‚Äúyou should eat at 7:35 AM.‚Äù
        
    - Suggestions are clearly labeled and dismissible.
        
- **Focuses on unique value**  
    Things _they can‚Äôt get easily from other tools_:
    
    - Cross-course deadlines.
        
    - Conflicts and tight transitions.
        
    - Smart suggestions using their gaps.
        
- **Customizable without being a settings hell**  
    Three key dimensions:
    
    - Mode: Minimal / Focused / Coach
        
    - What to show: deadlines / classes / suggestions / wellness
        
    - When to ping: night / morning / only important days / never
        
- **Architecturally sane long-term**
    
    - All of this is just structured data + a few preferences.
        
    - You‚Äôre not reinventing the workflow system, just telling it to generate better content and present it in a more student-brained way.
        

## 1. Architecture sanity check

Given what you pasted:

- **Core pieces already exist and are compatible:**
    
    - Temporal `StudentWatcher` workflow runs per-student, checks every 5 minutes, and triggers `generateMorningPlan(...)`.
        
    - `generateDayPlan(...)` builds a JSON `DayPlan` object and stores it in `day_plans.plan_data` (JSONB).
        
    - Separate activity prepares email data (`prepareDayPlanEmailData`) and sends via Customer.io.
        
    - Preferences already live in `accounts.preferences` and are JSON-based.
        

That‚Äôs actually perfect for what you want:

- **You don‚Äôt need new infra** (no new service, no new DB tables).
    
- You‚Äôre primarily:
    
    - changing **what the LLM outputs**,
        
    - how you **shape that JSON**, and
        
    - how you **selectively render** parts of it into email.
        

### Where your proposed changes plug in cleanly

**a) Priority-first DayPlan structure (dueToday, classes, conflicts, suggestions)**  
‚úÖ Fits naturally into the existing `DayPlan` JSON and DB:

- `plan_data` is JSONB ‚Üí you can safely **add new fields** like `dueToday`, `hardCommitments`, `conflicts`, `suggestedBlocks` without schema migrations.
    
- The report already shows `version: number` on `DayPlan`, so you can bump versions and evolve the shape over time.
    
- Old plans can still be read as long as your email renderer is defensive (null checks, sensible fallbacks).
    

**b) User preferences (minimal vs coach mode, meals/wellness toggles)**  
‚úÖ Aligns with `accounts.preferences`:

- Preferences are JSON ‚Üí just extend them with a `dayPlan` object:
    
    ```json
    "dayPlan": {
      "mode": "minimal",
      "includeMeals": false,
      "includeWellness": false,
      "includeStudySuggestions": true
    }
    ```
    
- You don‚Äôt need a DB migration for a strict column, just:
    
    - default values in app code,
        
    - careful null handling.
        

**c) Changing ‚Äú5 AM email‚Äù behavior**  
‚úÖ StudentWatcher is already time-zone aware and loops every 5 minutes:

- Easiest safe move: **change 5 ‚Üí 8** in the ‚Äúgenerate and send‚Äù check.
    
- More advanced: decouple **plan generation time** from **email send time**, but you can do that later.
    
- You already have `student_watcher_state.last_email_sent_date` which protects you from duplicate sends.
    

**d) Removing meals, wellness fluff, ‚Äúfree time‚Äù blocks**  
‚úÖ Purely content-level:

- This lives in:
    
    - LLM prompt (`dayplan.system` / `dayplan.user.baseline`),
        
    - how you transform the LLM output into `events` / `actions`,
        
    - `prepareDayPlanEmailData()` mapping.
        
- None of that breaks Temporal workflow structure, DB schema, or Customer.io API.
    

### Long-term concerns (and how to avoid issues)

As long as you follow these rules, you‚Äôre good for ‚Äúyears‚Äù:

1. **Treat `DayPlan` JSON as a versioned internal API.**
    
    - Keep `version` on `DayPlan` and bump it when you change structure.
        
    - Make email renderer handle both `version 1` and `version 2+` gracefully.
        
    - Keep changes **additive** when possible (add new fields rather than renaming/removing old ones immediately).
        
2. **Be defensive in `prepareDayPlanEmailData`.**
    
    - Expect fields to be missing:
        
        - If `dueToday` missing ‚Üí infer from `events` as fallback, or just send a minimal email.
            
        - If `suggestedBlocks` missing ‚Üí simply don‚Äôt render that section.
            
    - This avoids runtime errors if old data or weird LLM outputs sneak in.
        
3. **Keep the Temporal workflow contracts stable.**
    
    - Don‚Äôt change workflow IDs, signal names, or basic activity signatures unless you plan a migration.
        
    - Inside `generateDayPlan`, you can refactor as much as you like as long as it still:
        
        - returns a valid `DayPlan`,
            
        - writes to `day_plans`,
            
        - triggers email activity when appropriate.
            
4. **Add small tests around schema & JSON parsing.**
    
    - Even just:
        
        - ‚ÄúLLM response ‚Üí JSON.parse ‚Üí matches expected shape (or at least core fields)‚Äù.
            
        - ‚ÄúprepareDayPlanEmailData doesn‚Äôt throw when certain fields are null/missing.‚Äù
            

If you do that, all the changes you want (less micromanaging, more priorities, more opt-in) are **structural upgrades** on top of a sound architecture. Nothing here is a hack.

---

## 2. Agent-ready spec (copy-paste this into Claude / your coding agent)

Here‚Äôs a clean brief you can hand to your coding agent so it:

1. Investigates the current system
    
2. Confirms compatibility
    
3. Implements the new behavior safely
    

---

### üß† Task: Refactor DayPlan to a Priority-First, Student-Respectful Design

#### 0. Context

We already have a DayPlan system documented in:

- `DAYPLAN_SYSTEM_REPORT.md`
    
- `DAYPLAN_REDESIGN_ANALYSIS.md`
    

Core components (from code + report):

- Temporal workflow: `studentWatcher.simplified.workflow.ts`
    
- DayPlan generation: `services/engine/src/activities/dayplan.activities.ts`
    
- Email personalization: `dayplan-email-personalization.ts`
    
- Notifications: `notification.activities.ts`
    
- Admin routes: `services/api-router/src/routes/admin/dayplan-admin-actions.ts`
    
- Storage: `day_plans.plan_data` (JSONB with `DayPlan` object)
    

Your job is to **reshape the content and schema of DayPlan** so that:

- It emphasizes **today‚Äôs priorities and risks** (deadlines, classes, conflicts).
    
- It removes micromanaging behavior (pre-scheduling meals/free time).
    
- It supports different student preferences (minimal vs ‚Äúcoach‚Äù mode).
    
- It remains compatible with the existing architecture for years.
    

---

### 1. Investigation Checklist (don‚Äôt change anything yet)

1. **Confirm DayPlan schema & versioning**
    
    - Find the `DayPlan` TypeScript interface in the codebase (likely in `dayplan.activities.ts` or shared types).
        
    - Confirm:
        
        - `version: number` exists.
            
        - Where `plan_data` is written into `day_plans` table.
            
2. **Map where each piece of content is generated**
    
    - In `dayplan.activities.ts`, identify:
        
        - function(s) that call the LLM (GPT-4o-mini),
            
        - where the prompt is built (system + user),
            
        - where the LLM JSON is parsed into a `DayPlan`.
            
    - In `prepareDayPlanEmailData()`:
        
        - See which `DayPlan` fields are used for:
            
            - events/timeline
                
            - ‚Äúwellness tips‚Äù
                
            - ‚Äúmeals‚Äù
                
            - ‚Äúroutines‚Äù
                
            - ‚Äúfree time‚Äù
                
            - ‚Äúheads up‚Äù / ‚Äúinsights‚Äù.
                
    - In `Customer.io` template expectations:
        
        - Identify which fields from `DayPlanEmailData` need to remain stable.
            
3. **Confirm workflow + email timing**
    
    - In `studentWatcher.simplified.workflow.ts`:
        
        - Find the 5 AM check and confirm:
            
            - It triggers DayPlan generation.
                
            - It passes `sendNotifications: true`.
                
        - Confirm where email vs push is actually sent.
            
4. **Inspect preferences model**
    
    - Find `accounts` table and type describing `accounts.preferences`.
        
    - Check how preferences are read for:
        
        - `notifications.dayPlanEmails`.
            
    - Confirm there is a place we can safely add `dayPlan`-related preferences.
        

Output of investigation: a short summary of:

- Current `DayPlan` shape.
    
- How the email is built.
    
- How/when the workflow sends notifications.
    
- Any tight couplings that would break if the schema changes.
    

---

### 2. Target Behavior (What We Want)

#### 2.1 DayPlan content model

We want to evolve `DayPlan` towards something like:

```ts
interface DayPlan {
  planId: string;
  studentId: string;
  date: string;
  version: number;
  timezone: string;

  hardCommitments: TimelineEvent[];    // classes, exams, fixed events
  dueToday: AssignmentEvent[];         // assignments/assessments due on this date
  nearFuture?: AssignmentEvent[];      // next 2‚Äì3 days (optional)
  conflicts?: ConflictAlert[];         // only present if there are conflicts
  suggestedBlocks?: SuggestedBlock[];  // optional ‚Äúsuggested, not mandatory‚Äù work blocks

  summary: {
    load: 'light' | 'moderate' | 'heavy';
    mainPriority?: string;             // one short sentence
    bestWorkWindow?: TimeRange;        // optional
  };

  // Existing fields like insights, actions, notificationContent can remain for now,
  // but we want the NEW fields above to be the primary source of truth for emails.
}
```

Key rules:

- `hardCommitments` = only things that are actually fixed in time (classes, exams, events).
    
- `dueToday` = anything with a deadline **today**, regardless of whether it‚Äôs in the calendar.
    
- `conflicts` exists **only** if there‚Äôs something to show.
    
- `suggestedBlocks` = clearly labeled as suggestions, not guaranteed schedule.
    

#### 2.2 Preferences model

Extend `accounts.preferences` with:

```json
"dayPlan": {
  "mode": "minimal" | "coach",
  "includeMeals": false,
  "includeWellness": false,
  "includeStudySuggestions": true
}
```

Defaults (for now, even if not exposed via UI):

- `mode`: `"minimal"`
    
- `includeMeals`: `false`
    
- `includeWellness`: `false`
    
- `includeStudySuggestions`: `true`
    

These values should be read in `generateDayPlan` and in the email builder.

---

### 3. LLM + Generation Changes

#### 3.1 Prompt adjustments

Update the DayPlan prompt templates (system + user) so the model is instructed to:

- **Must include**:
    
    - `dueToday`
        
    - `hardCommitments`
        
    - `conflicts` (if any)
        
    - `summary` (load + one main priority)
        
- **Optional**, controlled by preferences:
    
    - `suggestedBlocks` (if `includeStudySuggestions === true`)
        
- **Explicitly avoid**:
    
    - Scheduling meals, ‚Äúmorning routines‚Äù, ‚Äúwind down routines‚Äù, ‚Äúfree time‚Äù unless:
        
        - `preferences.dayPlan.includeMeals === true` or
            
        - `preferences.dayPlan.includeWellness === true`.
            
    - Generic health tips (‚Äústay hydrated‚Äù) that are not specific to the actual schedule.
        

The prompt should explicitly say:

- ‚ÄúTreat `suggestedBlocks` as **suggestions only**, not fixed schedule.‚Äù
    
- ‚ÄúNever label ‚ÄòFree time‚Äô as an event.‚Äù
    
- ‚ÄúKeep your output within the JSON schema, and don‚Äôt invent extra top-level fields.‚Äù
    

#### 3.2 Parsing & validation

- Update the DayPlan TypeScript type definition to include the new fields.
    
- Ensure the LLM JSON is parsed and validated:
    
    - If a field is missing, default to:
        
        - `hardCommitments = []`, `dueToday = []`, etc.
            
    - If parsing fails, log and fall back to the old shape or a minimal plan.
        

---

### 4. Email Builder Changes

In `prepareDayPlanEmailData()`:

1. **Reshape the email sections to use new fields**:
    
    - `DUE TODAY` ‚Üí from `plan.dueToday`.
        
    - `CLASSES` ‚Üí from `plan.hardCommitments` filtered to class-type events.
        
    - `CONFLICTS` ‚Üí from `plan.conflicts`, but only if non-empty.
        
    - `SUGGESTED BLOCKS` ‚Üí from `plan.suggestedBlocks`, only if:
        
        - `preferences.dayPlan.mode === 'coach'` and
            
        - `includeStudySuggestions === true` and
            
        - there is at least one block.
            
2. **Remove by default**:
    
    - Timeline entries that are:
        
        - meals,
            
        - ‚Äúfree time‚Äù,
            
        - generic ‚Äúroutines‚Äù,
            
        - generic wellness-only events.
            
    - Generic `wellness_tips` section in the email payload, unless:
        
        - `includeWellness === true`
            
        - AND the tips are specific to today‚Äôs schedule (not generic).
            
3. **The email layout should become:**
    
    - Subject line:
        
        - If there is at least one `dueToday`:  
            `Due today: <top-priority assignment> (<due time>)`
            
        - Otherwise, something like:  
            `2 classes today, light schedule` (derived from `summary.load` and `hardCommitments.length`)
            
    - Body sections in order:
        
        1. `DUE TODAY` (if any)
            
        2. `CLASSES` (for today)
            
        3. `COMING UP` (optional, from `nearFuture`)
            
        4. `Suggested blocks` (optional, see prefs)
            
        5. Single CTA: ‚ÄúView today in DormWay‚Äù
            
4. **Make the builder defensive**:
    
    - If `plan.version` is older and fields like `dueToday` aren‚Äôt present:
        
        - Derive minimally from existing `events` / `actions` if possible.
            
        - Or send a simplified email instead of failing.
            

---

### 5. Timing / Workflow Logic

In `studentWatcher.simplified.workflow.ts`:

1. **Confirm current logic**:
    
    - Identify the exact condition where DayPlan is generated and email is sent:
        
        ```ts
        if (userHour === 5 && userMinute < 5 && needsNewDayPlan) {
          await generateMorningPlan(..., sendNotifications: true)
        }
        ```
        
2. **Change behavior to be more student-friendly**:
    
    - First iteration (simplest, safe change):
        
        - Change `5` to `8` to send around 8 AM local time.
            
    - Optional improvement:
        
        - After generating the plan, inspect `dueToday` + `summary.load`:
            
            - If `dueToday.length === 0` and `summary.load === 'light'`  
                ‚Üí skip sending email for that day (but still store DayPlan).
                
            - Use `student_watcher_state.last_email_sent_date` to avoid duplicates.
                

**Important**: Don‚Äôt change workflow IDs or signal names; keep the same structure, just adjust timing and conditions inside the loop.

---

### 6. Preferences (Backend Only for Now)

- Extend `accounts.preferences` type to include `.dayPlan` as defined above.
    
- Provide a function that returns **merged defaults**:
    
    - If `preferences.dayPlan` is missing ‚Üí return defaults.
        
    - This function should be used by:
        
        - `generateDayPlan`
            
        - `prepareDayPlanEmailData`
            

This allows adding a UI later without breaking anything.

---

### 7. Testing & Acceptance Criteria

Add or update tests (unit or integration) to confirm:

1. **DayPlan generation**
    
    - Given:
        
        - 2 classes, 1 assignment due today, normal schedule,
            
        - default dayPlan preferences (minimal, no meals/wellness).
            
    - Then:
        
        - `dueToday` has the assignment.
            
        - `hardCommitments` only has the two classes.
            
        - `suggestedBlocks` is present only if we enable coach mode.
            
2. **Email content**
    
    - For the above DayPlan:
        
        - The email payload has a `DUE TODAY` section.
            
        - No meals, routines, ‚Äúfree time‚Äù, or generic wellness tips appear.
            
    - For a ‚Äúno deadlines, light day‚Äù DayPlan:
        
        - Email either:
            
            - does not send, or
                
            - has a very small ‚Äúlight day‚Äù summary with no fluff.
                
3. **Timing**
    
    - Simulate user timezone logic and assert that:
        
        - The workflow triggers email generation/sending at ~8 AM local time.
            
        - `last_email_sent_date` prevents duplicate sending.
            

If all of the above passes and logs show no new errors, the refactor is considered successful.
